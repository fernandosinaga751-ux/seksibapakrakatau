<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iuran Seksi Bapa â€” Sistem Sektor</title>
<!-- Firebase SDKs -->
<script type="module">
  // Firebase loaded below via compat SDKs
</script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --gold:#C9A84C;--gold-light:#F0D68A;--gold-dark:#8B6914;
  --cream:#FBF6ED;--cream-dark:#F2E9D8;
  --brown:#3D2B1F;--brown-light:#A07850;
  --green:#2D5A3D;--green-light:#4A8C63;
  --red:#8B2222;--red-light:#C94040;
  --blue:#1e40af;--orange:#B45309;
  --s1:#1B4F8A;--s2:#2D5A3D;--s3:#6B2D8B;--s4:#8B3A0F;
  --text:#2A1F14;--text-muted:#7A6550;--border:#D4B896;--shadow:rgba(61,43,31,0.12);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 10%,rgba(201,168,76,.07) 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 80% 90%,rgba(45,90,61,.06) 0%,transparent 60%);pointer-events:none;z-index:0;}
.page{position:relative;z-index:1;min-height:100vh;}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-5px)}50%{transform:translateX(5px)}}
@keyframes pop{0%{transform:scale(.95)}60%{transform:scale(1.02)}100%{transform:scale(1)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}

/* HEADER */
header{background:linear-gradient(135deg,var(--brown) 0%,#5A3821 100%);color:var(--cream);text-align:center;padding:2rem 1rem 1.6rem;position:relative;overflow:hidden;}
header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.hdr-orn{font-size:1rem;color:var(--gold-light);letter-spacing:.5rem;margin-bottom:.3rem;}
header h1{font-family:'Playfair Display',serif;font-size:clamp(1.4rem,4vw,2rem);font-weight:700;color:#fff;}
header p{font-family:'Lora',serif;font-style:italic;color:var(--gold-light);margin-top:.25rem;font-size:.85rem;}
.badge-tahun{display:inline-block;margin-top:.6rem;background:rgba(201,168,76,.2);border:1px solid var(--gold);color:var(--gold-light);padding:.2rem .9rem;border-radius:20px;font-size:.77rem;}

/* COMMON */
.container{max-width:660px;margin:0 auto;padding:1.6rem 1rem;}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:1.6rem;box-shadow:0 4px 24px var(--shadow);margin-bottom:1.2rem;animation:fadeUp .4s ease both;}
.card-title{font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--brown);margin-bottom:1.1rem;display:flex;align-items:center;gap:.6rem;padding-bottom:.65rem;border-bottom:1px solid var(--cream-dark);}
.ico{width:30px;height:30px;background:var(--cream-dark);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.card-meta{font-size:.77rem;color:var(--text-muted);margin-left:auto;}
.fg{margin-bottom:1rem;}
label{display:block;font-size:.77rem;font-weight:600;color:var(--text-muted);margin-bottom:.3rem;letter-spacing:.04em;text-transform:uppercase;}
input,select{width:100%;padding:.72rem .9rem;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.91rem;background:var(--cream);color:var(--text);transition:border-color .2s,box-shadow .2s;outline:none;}
input:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,.15);background:#fff;}
.hint{font-size:.76rem;color:var(--text-muted);margin-top:.3rem;font-family:'Lora',serif;font-style:italic;}

/* BUTTONS */
.btn{padding:.78rem 1rem;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .2s;width:100%;}
.btn:hover{transform:translateY(-1px);}
.btn-primary{background:linear-gradient(135deg,var(--brown),#5A3821);color:#fff;}
.btn-primary:hover{box-shadow:0 6px 18px rgba(61,43,31,.3);}
.btn-gold{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#fff;}
.btn-gold:hover{box-shadow:0 6px 18px rgba(201,168,76,.4);}
.btn-green{background:linear-gradient(135deg,var(--green),#1A3D28);color:#fff;}
.btn-green:hover{box-shadow:0 6px 18px rgba(45,90,61,.35);}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text-muted);width:auto;padding:.42rem .9rem;font-size:.8rem;}
.btn-outline:hover{border-color:var(--brown);color:var(--brown);}
.btn-sm{width:auto;padding:.33rem .75rem;font-size:.76rem;border-radius:7px;}
.btn-danger{background:#fee2e2;color:var(--red);border:1px solid #fca5a5;}
.btn-confirm{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7;}
.btn-reject{background:#fee2e2;color:var(--red);border:1px solid #fca5a5;}

/* BADGE */
.badge{display:inline-flex;align-items:center;gap:.2rem;padding:.18rem .55rem;border-radius:20px;font-size:.68rem;font-weight:600;}
.badge-lunas{background:#d1fae5;color:#065f46;}
.badge-belum{background:#fef3c7;color:#92400e;}
.badge-pending{background:#dbeafe;color:#1e40af;}
.sector-badge{display:inline-flex;align-items:center;gap:.25rem;padding:.2rem .65rem;border-radius:12px;font-size:.72rem;font-weight:700;letter-spacing:.03em;}
.s1-badge{background:#dbeafe;color:var(--s1);}
.s2-badge{background:#d1fae5;color:var(--s2);}
.s3-badge{background:#ede9fe;color:var(--s3);}
.s4-badge{background:#ffedd5;color:var(--s4);}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:.8rem;margin-bottom:1.2rem;}
.stats-row-4{grid-template-columns:repeat(4,1fr);}
.stat-box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:.8rem;text-align:center;box-shadow:0 2px 10px var(--shadow);}
.stat-num{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--brown);line-height:1;}
.stat-num.pend{color:var(--orange);}
.stat-label{font-size:.67rem;color:var(--text-muted);margin-top:.18rem;text-transform:uppercase;letter-spacing:.05em;}

/* SECTOR CARDS */
.sector-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.2rem;}
.sector-card{border-radius:14px;padding:1.1rem;cursor:pointer;transition:all .2s;border:2px solid transparent;position:relative;overflow:hidden;}
.sector-card::before{content:'';position:absolute;inset:0;opacity:.08;}
.sector-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.15);}
.sc-1{background:linear-gradient(135deg,#1B4F8A,#0d2d5a);color:#fff;}
.sc-2{background:linear-gradient(135deg,#2D5A3D,#1A3D28);color:#fff;}
.sc-3{background:linear-gradient(135deg,#6B2D8B,#44196f);color:#fff;}
.sc-4{background:linear-gradient(135deg,#8B3A0F,#5e2608);color:#fff;}
.sc-ico{font-size:1.8rem;margin-bottom:.4rem;}
.sc-name{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;}
.sc-info{font-size:.75rem;opacity:.75;margin-top:.2rem;}
.sc-count{position:absolute;top:.6rem;right:.7rem;background:rgba(255,255,255,.2);border-radius:20px;padding:.15rem .5rem;font-size:.7rem;font-weight:600;}

/* AUTOCOMPLETE */
.ac-wrap{position:relative;}
.ac-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--gold);border-radius:10px;margin-top:3px;box-shadow:0 8px 24px var(--shadow);z-index:200;max-height:200px;overflow-y:auto;display:none;}
.ac-list.show{display:block;}
.ac-item{padding:.58rem .95rem;cursor:pointer;font-size:.86rem;border-bottom:1px solid var(--cream-dark);display:flex;align-items:center;justify-content:space-between;}
.ac-item:last-child{border-bottom:none;}
.ac-item:hover{background:var(--cream);}

/* RESULT BOX */
#result-box{display:none;margin-top:1.2rem;border-radius:12px;padding:1.2rem;text-align:center;animation:pop .4s ease both;}
#result-box.lunas{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:1.5px solid #34d399;}
#result-box.belum{background:linear-gradient(135deg,#fef3c7,#fde68a);border:1.5px solid var(--gold);}
#result-box.pending{background:linear-gradient(135deg,#dbeafe,#bfdbfe);border:1.5px solid #60a5fa;}
#result-box.error{background:linear-gradient(135deg,#fee2e2,#fecaca);border:1.5px solid #f87171;}
.res-icon{font-size:1.9rem;margin-bottom:.3rem;}
.res-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:.25rem;}
.res-title.lunas{color:var(--green);}
.res-title.belum{color:var(--gold-dark);}
.res-title.pending{color:var(--blue);}
.res-title.error{color:var(--red);}
.res-msg{font-size:.84rem;color:var(--text);line-height:1.55;}
.res-nom{font-size:.95rem;font-weight:600;margin-top:.4rem;}

/* TOKEN INPUT */
.inp-token{border-color:#a5d6a7;background:#f1f8f4;}
.inp-token:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(45,90,61,.12);}
.token-valid{border-color:var(--green)!important;background:#d1fae5!important;}
.token-invalid{border-color:var(--red-light)!important;background:#fee2e2!important;animation:shake .35s ease;}
.tbadge{display:inline-flex;align-items:center;gap:.3rem;padding:.18rem .6rem;border-radius:12px;font-size:.73rem;font-weight:600;margin-top:.3rem;}
.tbadge-ok{background:#d1fae5;color:#065f46;}
.tbadge-err{background:#fee2e2;color:var(--red);}
.tbadge-warn{background:#fef3c7;color:#92400e;}

/* ADMIN HEADER */
.admin-hdr{padding:1.2rem 1rem;position:relative;}
.admin-hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.admin-hdr-inner{max-width:1000px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;}
.admin-hdr h1{font-family:'Playfair Display',serif;font-size:1.2rem;}
.admin-hdr p{font-family:'Lora',serif;font-style:italic;font-size:.79rem;opacity:.75;}

/* ADMIN TABS */
.admin-tabs{max-width:1000px;margin:1rem auto 0;display:flex;gap:.35rem;padding:0 1rem;flex-wrap:wrap;}
.tab-btn{padding:.45rem .9rem;border-radius:20px;border:1.5px solid var(--border);background:#fff;font-family:'DM Sans',sans-serif;font-size:.79rem;cursor:pointer;color:var(--text-muted);transition:all .2s;font-weight:500;position:relative;}
.tab-btn.active{background:var(--brown);color:#fff;border-color:var(--brown);}
.notif-dot{position:absolute;top:-4px;right:-4px;width:15px;height:15px;background:var(--red-light);border-radius:50%;font-size:.6rem;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;}
.admin-container{max-width:1000px;margin:0 auto;padding:1.2rem 1rem 3rem;}
.tab-content{display:none;}
.tab-content.active{display:block;animation:fadeUp .3s ease both;}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:12px;border:1px solid var(--border);box-shadow:0 2px 10px var(--shadow);}
table{width:100%;border-collapse:collapse;background:#fff;font-size:.82rem;}
thead th{background:var(--brown);color:#fff;padding:.68rem .85rem;text-align:left;font-weight:500;font-size:.72rem;letter-spacing:.04em;text-transform:uppercase;}
thead th:first-child{border-radius:12px 0 0 0;}
thead th:last-child{border-radius:0 12px 0 0;}
tbody tr{border-bottom:1px solid var(--cream-dark);}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:var(--cream);}
td{padding:.65rem .85rem;vertical-align:middle;}
.nc{font-weight:600;color:var(--brown);}
.prog-wrap{background:var(--cream-dark);border-radius:4px;height:6px;min-width:60px;overflow:hidden;}
.prog-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green-light),var(--green));transition:width .5s;}
.prog-fill.partial{background:linear-gradient(90deg,#f59e0b,#d97706);}

/* PENDING CARD */
.pcard{background:#fff;border:1.5px solid #bfdbfe;border-radius:12px;padding:1rem;margin-bottom:.75rem;transition:box-shadow .2s;}
.pcard:hover{box-shadow:0 4px 16px rgba(30,58,138,.1);}
.pcard-name{font-weight:600;font-family:'Playfair Display',serif;font-size:.95rem;color:var(--brown);}
.pcard-detail{font-size:.79rem;color:var(--text-muted);margin-top:.2rem;line-height:1.7;}
.pcard-detail strong{color:var(--text);}
.pcard-actions{display:flex;gap:.45rem;margin-top:.75rem;flex-wrap:wrap;}

/* LOGIN */
#login-overlay{max-width:400px;margin:3rem auto;padding:0 1rem;animation:fadeUp .4s ease both;}
.login-ico{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;font-size:1.5rem;}

/* INFO BOX */
.info-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1.5px solid var(--gold);border-radius:10px;padding:.8rem .95rem;margin-bottom:.95rem;font-size:.81rem;color:var(--gold-dark);line-height:1.6;}
.info-box strong{color:var(--brown);}
.info-box.green{background:linear-gradient(135deg,#ecfdf5,#d1fae5);border-color:#6ee7b7;color:#065f46;}
.info-box.blue{background:linear-gradient(135deg,#eff6ff,#dbeafe);border-color:#93c5fd;color:#1e40af;}
.info-box.purple{background:linear-gradient(135deg,#faf5ff,#ede9fe);border-color:#c4b5fd;color:#5b21b6;}
.info-box.orange{background:linear-gradient(135deg,#fff7ed,#ffedd5);border-color:#fdba74;color:#9a3412;}

/* DIVIDER */
.divider{display:flex;align-items:center;gap:.8rem;margin:1.1rem 0;color:var(--text-muted);font-size:.74rem;font-family:'Lora',serif;font-style:italic;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* MODE TOGGLE */
.mode-toggle{display:flex;gap:.4rem;margin-bottom:1rem;background:var(--cream-dark);padding:.28rem;border-radius:12px;}
.mode-btn{flex:1;padding:.48rem .5rem;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:500;cursor:pointer;transition:all .2s;color:var(--text-muted);background:transparent;}
.mode-btn.active{background:#fff;color:var(--brown);box-shadow:0 2px 8px var(--shadow);font-weight:600;}

/* TOAST */
#toast{position:fixed;bottom:1.8rem;left:50%;transform:translateX(-50%) translateY(80px);background:var(--brown);color:#fff;padding:.62rem 1.3rem;border-radius:24px;font-size:.82rem;box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:9999;transition:transform .3s;white-space:nowrap;max-width:90vw;text-align:center;}
#toast.show{transform:translateX(-50%) translateY(0);}

/* EMPTY */
.empty-state{text-align:center;padding:2.2rem 1rem;color:var(--text-muted);}
.empty-state .esi{font-size:1.8rem;margin-bottom:.4rem;}
.empty-state p{font-family:'Lora',serif;font-style:italic;font-size:.86rem;}

/* TOK CARD */
.tok-card{display:flex;align-items:center;gap:.7rem;padding:.65rem .85rem;background:#fff;border:1px solid var(--border);border-radius:10px;margin-bottom:.4rem;}
.tok-card:hover{background:var(--cream);}
.tok-info{flex:1;}
.tok-name{font-weight:600;font-size:.86rem;color:var(--brown);}
.tok-val{font-family:monospace;font-size:.8rem;color:var(--green);background:#d1fae5;display:inline-block;padding:.08rem .45rem;border-radius:6px;margin-top:.12rem;}
.tok-sector{font-size:.72rem;color:var(--text-muted);margin-top:.1rem;}

/* SECTOR SELECT */
.sector-select-row{display:flex;gap:.4rem;margin-bottom:1rem;flex-wrap:wrap;}
.ss-btn{flex:1;min-width:90px;padding:.45rem .5rem;border-radius:9px;border:2px solid var(--border);background:#fff;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:500;cursor:pointer;transition:all .2s;color:var(--text-muted);text-align:center;}
.ss-btn:hover{border-color:var(--gold);}
.ss-btn.active-s1{background:#dbeafe;color:var(--s1);border-color:var(--s1);font-weight:700;}
.ss-btn.active-s2{background:#d1fae5;color:var(--s2);border-color:var(--s2);font-weight:700;}
.ss-btn.active-s3{background:#ede9fe;color:var(--s3);border-color:var(--s3);font-weight:700;}
.ss-btn.active-s4{background:#ffedd5;color:var(--s4);border-color:var(--s4);font-weight:700;}

/* GS BOX */
.gs-box{background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border:1.5px solid #a5d6a7;border-radius:12px;padding:.95rem;margin-bottom:1.1rem;}
.gs-box h3{font-family:'Playfair Display',serif;font-size:.9rem;color:var(--green);margin-bottom:.35rem;}
.gs-box p{font-size:.79rem;color:#2d5a3d;line-height:1.65;}


/* SETUP STEPS */
.setup-step{display:flex;gap:.8rem;margin-bottom:1rem;align-items:flex-start;}
.step-num{width:26px;height:26px;background:linear-gradient(135deg,var(--brown),#5A3821);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0;margin-top:.1rem;}
.step-body{flex:1;}
.step-title{font-weight:700;font-size:.88rem;color:var(--brown);margin-bottom:.2rem;}
.step-desc{font-size:.8rem;color:var(--text-muted);line-height:1.65;}
.step-desc code{background:var(--cream-dark);padding:.1rem .35rem;border-radius:4px;font-family:monospace;font-size:.78rem;color:var(--brown);}
/* FIREBASE STATUS */
.fb-status{display:flex;align-items:center;gap:.5rem;padding:.5rem .8rem;border-radius:8px;font-size:.79rem;font-weight:600;margin-bottom:.5rem;}
.fb-online{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7;}
.fb-offline{background:#fee2e2;color:var(--red);border:1px solid #fca5a5;}
.fb-connecting{background:#fef3c7;color:var(--orange);border:1px solid #fde68a;}

/* RESPONSIVE */
footer{text-align:center;padding:1rem 1rem 2rem;color:var(--text-muted);font-size:.78rem;z-index:1;position:relative;}
@media(max-width:500px){
  .sector-grid{grid-template-columns:1fr 1fr;}
  .stats-row-4{grid-template-columns:repeat(2,1fr);}
  .card{padding:1.2rem;}
}
</style>

<!-- Konfigurasi Firebase (edit file config.js) -->
<script src="config.js"></script>
<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>


<!-- ======================== FIREBASE SETUP PAGE ======================== -->
<div id="setup-page" class="page" style="display:none;">
  <header>
    <div class="hdr-orn">â‹ â‹ â‹</div>
    <h1>Iuran Seksi Bapa</h1>
    <p>Konfigurasi Firebase â€” Penyimpanan Online</p>
  </header>
  <div class="container">
    <div class="card" style="border-color:#f59e0b;">
      <div class="card-title"><div class="ico" style="background:#fef3c7;">ğŸ”¥</div>Setup Firebase Diperlukan</div>
      <div class="info-box" style="background:linear-gradient(135deg,#fff7ed,#ffedd5);border-color:#fdba74;color:#9a3412;margin-bottom:1rem;">
        âš ï¸ <strong>Pertama kali?</strong> Ikuti panduan di bawah untuk menghubungkan aplikasi ke Firebase. Hanya perlu dilakukan sekali.
      </div>

      <!-- STEP BY STEP -->
      <div style="margin-bottom:1.2rem;">
        <div style="font-family:'Playfair Display',serif;font-size:.95rem;color:var(--brown);margin-bottom:.8rem;font-weight:700;">ğŸ“‹ Panduan Setup (5 Menit)</div>

        <div class="setup-step">
          <div class="step-num">1</div>
          <div class="step-body">
            <div class="step-title">Buka Firebase Console</div>
            <div class="step-desc">Kunjungi <a href="https://console.firebase.google.com" target="_blank" style="color:var(--green);font-weight:600;">console.firebase.google.com</a> dan login dengan akun Google Anda.</div>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">2</div>
          <div class="step-body">
            <div class="step-title">Buat Project Baru</div>
            <div class="step-desc">Klik <strong>"Add project"</strong> â†’ beri nama (misal: <em>iuran-seksi-bapa</em>) â†’ klik Continue â†’ disable Google Analytics (opsional) â†’ <strong>"Create project"</strong>.</div>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">3</div>
          <div class="step-body">
            <div class="step-title">Buat Firestore Database</div>
            <div class="step-desc">Di sidebar kiri klik <strong>"Firestore Database"</strong> â†’ <strong>"Create database"</strong> â†’ pilih <strong>"Start in test mode"</strong> â†’ pilih region terdekat (asia-southeast2 / Singapore) â†’ <strong>"Enable"</strong>.</div>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">4</div>
          <div class="step-body">
            <div class="step-title">Dapatkan Firebase Config</div>
            <div class="step-desc">Di sidebar klik âš™ï¸ <strong>"Project settings"</strong> â†’ scroll ke bawah â†’ klik ikon <strong>&lt;/&gt;</strong> (Web App) â†’ register app (beri nama apa saja) â†’ copy bagian <code>firebaseConfig</code>.</div>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">5</div>
          <div class="step-body">
            <div class="step-title">Atur Security Rules (Penting!)</div>
            <div class="step-desc">Di Firestore â†’ tab <strong>"Rules"</strong> â†’ ganti isinya dengan rules di bawah ini â†’ <strong>"Publish"</strong>:</div>
            <div style="background:#1a1a2e;border-radius:8px;padding:.8rem;margin-top:.5rem;font-family:monospace;font-size:.72rem;color:#a0e4b0;line-height:1.6;overflow-x:auto;">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /iuran/{document=**} {
      allow read, write: if true;
    }
  }
}</div>
          </div>
        </div>

        <div class="setup-step">
          <div class="step-num">6</div>
          <div class="step-body">
            <div class="step-title">Masukkan Config di Bawah</div>
            <div class="step-desc">Paste nilai dari firebaseConfig ke kolom-kolom di bawah ini.</div>
          </div>
        </div>
      </div>

      <!-- CONFIG FORM -->
      <div style="background:var(--cream-dark);border-radius:12px;padding:1.1rem;border:1px solid var(--border);">
        <div style="font-size:.8rem;font-weight:700;color:var(--brown);margin-bottom:.8rem;text-transform:uppercase;letter-spacing:.05em;">ğŸ”‘ Firebase Config</div>
        <div class="fg"><label>API Key</label><input type="text" id="fb-apiKey" placeholder="AIzaSy..."></div>
        <div class="fg"><label>Auth Domain</label><input type="text" id="fb-authDomain" placeholder="your-project.firebaseapp.com"></div>
        <div class="fg"><label>Project ID</label><input type="text" id="fb-projectId" placeholder="your-project-id"></div>
        <div class="fg"><label>Storage Bucket</label><input type="text" id="fb-storageBucket" placeholder="your-project.appspot.com"></div>
        <div class="fg" style="margin-bottom:0;"><label>App ID</label><input type="text" id="fb-appId" placeholder="1:123456:web:abc..."></div>
      </div>

      <div id="fb-setup-err" style="color:var(--red-light);font-size:.8rem;margin-top:.6rem;display:none;padding:.5rem;background:#fee2e2;border-radius:8px;"></div>
      <div id="fb-setup-testing" style="color:var(--orange);font-size:.8rem;margin-top:.6rem;display:none;padding:.5rem;background:#fef3c7;border-radius:8px;">â³ Menguji koneksi Firebase...</div>

      <button class="btn btn-primary" style="margin-top:1rem;" onclick="saveFirebaseConfig()">ğŸ”¥ Simpan & Hubungkan Firebase</button>
      <div style="text-align:center;margin-top:.7rem;">
        <button onclick="useLocalOnly()" style="background:none;border:none;color:var(--text-muted);font-size:.78rem;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">Gunakan penyimpanan lokal saja (tanpa online)</button>
      </div>
    </div>
  </div>
</div>

<!-- ======================== PUBLIC PAGE ======================== -->
<div id="public-page" class="page">
  <header>
    <div class="hdr-orn">â‹ â‹ â‹</div>
    <h1>Iuran Seksi Bapa Jemaat Krakatau</h1>
    <p>Pengelolaan Iuran Per Sektor</p>
    <div class="badge-tahun" id="badge-tahun">ğŸ“… Iuran Tahun 2026 Â· Rp 90.000/Tahun</div>
  </header>
  <div class="container">
    <div class="stats-row">
      <div class="stat-box"><div class="stat-num" id="s-anggota">0</div><div class="stat-label">Anggota</div></div>
      <div class="stat-box"><div class="stat-num" id="s-lunas">0</div><div class="stat-label">Lunas</div></div>
      <div class="stat-box"><div class="stat-num pend" id="s-pending">0</div><div class="stat-label">Menunggu</div></div>
    </div>

    <div class="card">
      <div class="card-title"><div class="ico">ğŸ’³</div>Lapor Pembayaran Iuran</div>
      <div class="mode-toggle">
        <button class="mode-btn active" id="mbtn-transfer" onclick="setMode('transfer')">ğŸ¦ Transfer/OVO/Dana</button>
        <button class="mode-btn" id="mbtn-token" onclick="setMode('token')">ğŸ”‘ Bayar Tunai (Token)</button>
      </div>
      <div class="info-box" id="mode-info">ğŸ¦ <strong>Mode Transfer:</strong> Isi nama, nominal dan nomor Dana/OVO. Admin akan memverifikasi dan mengkonfirmasi pembayaran Anda.</div>

      <div class="fg">
        <label>Nama Anggota</label>
        <div class="ac-wrap">
          <input type="text" id="inp-nama" placeholder="Ketik nama anggota..." autocomplete="off" oninput="onNamaInput()">
          <div class="ac-list" id="ac-nama"></div>
        </div>
        <div id="nama-sector-info" style="margin-top:.35rem;"></div>
      </div>
      <div class="fg">
        <label>Bulan Pembayaran</label>
        <select id="inp-bulan">
          <option value="">-- Pilih Bulan --</option>
          <option value="1">Januari</option><option value="2">Februari</option>
          <option value="3">Maret</option><option value="4">April</option>
          <option value="5">Mei</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">Agustus</option>
          <option value="9">September</option><option value="10">Oktober</option>
          <option value="11">November</option><option value="12">Desember</option>
        </select>
      </div>
      <div class="fg">
        <label>Nominal Dibayar (Rp)</label>
        <input type="number" id="inp-nominal" placeholder="Contoh: 90000" min="0" step="1000" oninput="updateHint()">
        <div class="hint" id="sisa-hint">ğŸ’¡ Iuran setahun penuh = Rp 90.000</div>
      </div>

      <!-- TRANSFER -->
      <div id="sec-transfer">
        <div class="fg">
          <label>No. HP Dana / OVO Pengirim</label>
          <input type="tel" id="inp-notr" placeholder="Contoh: 08123456789">
          <div class="hint">ğŸ“‹ Nomor HP yang digunakan untuk transfer</div>
        </div>
        <div class="fg">
          <label>Catatan (opsional)</label>
          <input type="text" id="inp-catatan" placeholder="Contoh: transfer tgl 25 via Dana">
        </div>
      </div>

      <!-- TOKEN -->
      <div id="sec-token" style="display:none;">
        <div class="fg">
          <label>Token Sektor Pengurus</label>
          <input type="password" id="inp-token" class="inp-token" placeholder="Masukkan token sektor..." oninput="cekTokenLive(this)">
          <div id="token-status" class="hint">ğŸ”‘ Token diberikan oleh pengurus / ketua sektor</div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="submitPayment()">âœ“ Kirim Pembayaran</button>
      <div id="result-box">
        <div class="res-icon" id="res-icon"></div>
        <div class="res-title" id="res-title"></div>
        <div class="res-msg" id="res-msg"></div>
        <div class="res-nom" id="res-nom"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><div class="ico">ğŸ”</div>Cek Status Iuran</div>
      <div class="fg">
        <label>Nama Anggota</label>
        <div class="ac-wrap">
          <input type="text" id="cek-nama" placeholder="Ketik nama anggota..." autocomplete="off">
          <div class="ac-list" id="ac-cek"></div>
        </div>
      </div>
      <button class="btn btn-gold" onclick="cekStatus()">ğŸ” Cek Status</button>
      <div id="cek-result" style="margin-top:1rem;"></div>
    </div>

    <div class="divider">â‹ â‹ â‹</div>
  </div>
  <footer>
    <div>Dibuat dengan â¤ï¸ untuk pelayanan gereja</div>
    <div style="margin-top:.5rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <button onclick="goAdmin()" style="background:none;border:none;color:var(--brown-light);font-size:.79rem;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">ğŸ”’ Admin Utama</button>
      <button onclick="goTokenDashboard()" style="background:none;border:none;color:var(--green);font-size:.79rem;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">ğŸ”‘ Dashboard Sektor</button>
    </div>
  </footer>
</div>

<!-- ======================== ADMIN UTAMA ======================== -->
<div id="admin-page" class="page" style="display:none;">
  <div id="login-overlay">
    <div class="card">
      <div class="login-ico" style="background:linear-gradient(135deg,var(--brown),#5A3821);">ğŸ”’</div>
      <div class="card-title" style="justify-content:center;border-bottom:none;margin-bottom:.7rem;">Admin Utama</div>
      <p style="text-align:center;color:var(--text-muted);font-family:'Lora',serif;font-style:italic;font-size:.86rem;margin-bottom:1.1rem;">Masukkan password untuk mengakses panel admin utama</p>
      <div class="fg">
        <label>Password Admin</label>
        <input type="password" id="admin-pass" placeholder="..." onkeydown="if(event.key==='Enter')doLogin()">
        <div id="pass-err" style="color:var(--red-light);font-size:.77rem;margin-top:.3rem;display:none;">âŒ Password salah!</div>
      </div>
      <button class="btn btn-primary" onclick="doLogin()">Masuk Admin</button>
      <div class="text-center" style="margin-top:.7rem;">
        <button onclick="goPublic()" style="background:none;border:none;color:var(--text-muted);font-size:.79rem;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">â† Kembali</button>
      </div>
    </div>
  </div>

  <div id="admin-dashboard" style="display:none;">
    <div class="admin-hdr" style="background:linear-gradient(135deg,var(--brown),#5A3821);color:#fff;">
      <div class="admin-hdr-inner">
        <div>
          <h1>ğŸ› Panel Admin Utama</h1>
          <p>Kelola anggota, token sektor, dan seluruh data iuran</p>
          <div id="fb-indicator-admin" class="fb-status fb-connecting" style="margin-top:.4rem;display:inline-flex;">â³ Menghubungkan Firebase...</div>
        </div>
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
          <span id="idle-countdown-admin" style="font-size:.72rem;color:rgba(255,255,255,.55);"></span>
          <button onclick="goPublic()" style="background:none;border:none;color:rgba(255,255,255,.7);font-size:.79rem;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">â† Ke Halaman Iuran</button>
          <button class="btn btn-outline btn-sm" onclick="doLogout()" style="background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.3);color:#fff;">Keluar</button>
        </div>
      </div>
    </div>
    <div class="admin-tabs">
      <button class="tab-btn active" onclick="switchAdminTab('atab-anggota',this)">ğŸ‘¥ Anggota</button>
      <button class="tab-btn" onclick="switchAdminTab('atab-konfirmasi',this)">
        âœ“ Konfirmasi
        <span class="notif-dot" id="admin-konfirmasi-dot" style="display:none;">0</span>
      </button>
      <button class="tab-btn" onclick="switchAdminTab('atab-rekap',this)">ğŸ“Š Rekap</button>
      <button class="tab-btn" onclick="switchAdminTab('atab-riwayat',this)">ğŸ“‹ Riwayat</button>
      <button class="tab-btn" onclick="switchAdminTab('atab-sinkron',this)">ğŸ”— Google Sheets</button>
      <button class="tab-btn" onclick="switchAdminTab('atab-setting',this)">âš™ Pengaturan</button>
    </div>
    <div class="admin-container">
      <div class="stats-row stats-row-4" style="max-width:100%">
        <div class="stat-box"><div class="stat-num" id="a-anggota">0</div><div class="stat-label">Total Anggota</div></div>
        <div class="stat-box"><div class="stat-num" id="a-lunas">0</div><div class="stat-label">Lunas</div></div>
        <div class="stat-box"><div class="stat-num pend" id="a-pending">0</div><div class="stat-label">Menunggu</div></div>
        <div class="stat-box"><div class="stat-num" id="a-terkumpul">Rp 0</div><div class="stat-label">Terkumpul</div></div>
      </div>

      <!-- TAB ANGGOTA ADMIN -->
      <div id="atab-anggota" class="tab-content active">
        <div class="card">
          <div class="card-title"><div class="ico">â•</div>Tambah Anggota Baru</div>
          <div class="fg"><label>Nama Lengkap</label><input type="text" id="new-name" placeholder="Nama anggota..."></div>
          <div class="fg">
            <label>Sektor</label>
            <div class="sector-select-row" id="new-member-sector-row">
              <button class="ss-btn" onclick="selectSector(1,this)" id="ss1">Sektor 1</button>
              <button class="ss-btn" onclick="selectSector(2,this)" id="ss2">Sektor 2</button>
              <button class="ss-btn" onclick="selectSector(3,this)" id="ss3">Sektor 3</button>
              <button class="ss-btn" onclick="selectSector(4,this)" id="ss4">Sektor 4</button>
            </div>
            <div class="hint">Pilih sektor untuk anggota baru</div>
          </div>
          <button class="btn btn-primary" onclick="addMember()">Simpan Anggota</button>
        </div>

        <!-- PER SEKTOR -->
        <div id="sektor-anggota-container"></div>
      </div>

      <!-- TAB KONFIRMASI -->
      <div id="atab-konfirmasi" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">â³</div>Pengajuan Transfer Menunggu Konfirmasi <span class="card-meta" id="jml-pend-lbl">0 pengajuan</span></div>
          <div id="pending-list"></div>
          <div id="pending-empty" class="empty-state" style="display:none;"><div class="esi">âœ“</div><p>Tidak ada pengajuan yang perlu dikonfirmasi</p></div>
        </div>
      </div>

      <!-- TAB REKAP -->
      <div id="atab-rekap" class="tab-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;flex-wrap:wrap;gap:.5rem;">
          <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--brown);">ğŸ“Š Rekap Iuran Per Anggota</div>
          <div style="display:flex;gap:.4rem;">
            <button class="btn btn-outline btn-sm" onclick="filterRekap(0)">Semua</button>
            <button class="btn btn-outline btn-sm" onclick="filterRekap(1)">S1</button>
            <button class="btn btn-outline btn-sm" onclick="filterRekap(2)">S2</button>
            <button class="btn btn-outline btn-sm" onclick="filterRekap(3)">S3</button>
            <button class="btn btn-outline btn-sm" onclick="filterRekap(4)">S4</button>
            <button class="btn btn-outline btn-sm" onclick="exportCSV()">â¬‡ CSV</button>
          </div>
        </div>
        <div class="card" style="padding:0;overflow:hidden;">
          <div class="table-wrap" style="border:none;box-shadow:none;">
            <table>
              <thead><tr><th>#</th><th>Nama</th><th>Sektor</th><th>Dibayar</th><th>Sisa</th><th>Progres</th><th>Status</th></tr></thead>
              <tbody id="rekap-tbody"></tbody>
            </table>
          </div>
          <div id="rekap-empty" class="empty-state" style="display:none;"><div class="esi">ğŸ“Š</div><p>Belum ada data</p></div>
        </div>
      </div>

      <!-- TAB RIWAYAT ADMIN -->
      <div id="atab-riwayat" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ“‹</div>Riwayat Pembayaran Terverifikasi
            <button class="btn btn-danger btn-sm" onclick="adminHapusRiwayat()" style="margin-left:auto;">ğŸ—‘ Hapus Semua Riwayat</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>#</th><th>Nama</th><th>Sektor</th><th>Bulan</th><th>Nominal</th><th>Metode</th><th>Tgl Bayar</th><th>Dikonfirmasi Oleh</th><th>Tgl Konfirmasi</th></tr></thead>
              <tbody id="admin-riwayat-tbody"></tbody>
            </table>
          </div>
          <div id="admin-riwayat-empty" class="empty-state" style="display:none;"><div class="esi">ğŸ“‹</div><p>Belum ada riwayat</p></div>
        </div>
      </div>

      <!-- TAB GOOGLE SHEETS -->
      <div id="atab-sinkron" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ”—</div>Sinkronisasi Google Sheets</div>
          <div class="gs-box">
            <h3>ğŸŸ¢ Cara Setup</h3>
            <p>1. Buka <a href="https://script.google.com" target="_blank" style="color:var(--green);">script.google.com</a> â†’ New Project<br>
            2. Paste script di bawah â†’ Deploy sebagai Web App (Anyone)<br>
            3. Copy URL â†’ paste di bawah â†’ Sinkronkan</p>
          </div>
          <div class="fg"><label>Apps Script URL</label><input type="url" id="gs-url" placeholder="https://script.google.com/macros/s/.../exec"></div>
          <div style="display:flex;gap:.5rem;margin-bottom:1rem;">
            <button class="btn btn-gold" style="width:auto;padding:.62rem 1.1rem;" onclick="syncToSheets()">ğŸ”„ Sinkronkan</button>
            <button class="btn btn-outline" onclick="saveGsUrl()">ğŸ’¾ Simpan URL</button>
          </div>
          <div id="sync-status" style="font-size:.77rem;margin-bottom:1rem;display:none;padding:.5rem;border-radius:8px;"></div>
          <div class="divider">Google Apps Script</div>
          <div style="background:#1a1a2e;border-radius:10px;padding:1rem;overflow-x:auto;">
            <pre id="gs-script" style="color:#a0e4b0;font-size:.7rem;line-height:1.65;white-space:pre-wrap;font-family:monospace;">function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var data = JSON.parse(e.postData.contents);
  var s1 = ss.getSheetByName("Rekap Iuran") || ss.insertSheet("Rekap Iuran");
  s1.clearContents();
  s1.appendRow(["No","Nama","Sektor","Total Dibayar","Sisa","Status","Update"]);
  s1.getRange(1,1,1,7).setBackground("#3D2B1F").setFontColor("white").setFontWeight("bold");
  data.rows.forEach(function(r,i){ s1.appendRow([i+1,r.nama,r.sektor,r.total,r.sisa,r.status,r.updateAt]); });
  var s2 = ss.getSheetByName("Riwayat Bayar") || ss.insertSheet("Riwayat Bayar");
  s2.clearContents();
  s2.appendRow(["No","Nama","Sektor","Bulan","Nominal","Metode","Tgl Bayar","Dikonfirmasi Oleh","Tgl Konfirmasi"]);
  s2.getRange(1,1,1,9).setBackground("#2D5A3D").setFontColor("white").setFontWeight("bold");
  data.riwayat.forEach(function(r,i){ s2.appendRow([i+1,r.nama,r.sektor,r.bulan,r.nominal,r.metode,r.tglBayar,r.dikonfirmasiOleh,r.tglKonfirmasi]); });
  var s3 = ss.getSheetByName("Menunggu Konfirmasi") || ss.insertSheet("Menunggu Konfirmasi");
  s3.clearContents();
  s3.appendRow(["No","Nama","Sektor","Bulan","Nominal","No Transfer","Catatan","Waktu"]);
  s3.getRange(1,1,1,8).setBackground("#B45309").setFontColor("white").setFontWeight("bold");
  data.pending.forEach(function(r,i){ s3.appendRow([i+1,r.nama,r.sektor,r.bulan,r.nominal,r.noTransfer,r.catatan,r.tglSubmit]); });
  return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
}</pre>
          </div>
          <button class="btn btn-outline btn-sm" style="margin-top:.6rem;" onclick="copyScript()">ğŸ“‹ Copy Script</button>
        </div>
      </div>

      <!-- TAB SETTING -->
      <div id="atab-setting" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">âš™</div>Pengaturan Umum</div>
          <div class="fg"><label>Nama Organisasi</label><input type="text" id="set-org"></div>
          <div class="fg"><label>Tahun Iuran</label><input type="number" id="set-tahun"></div>
          <div class="fg"><label>Nominal Iuran / Tahun (Rp)</label><input type="number" id="set-nominal" step="5000"></div>
          <div class="fg"><label>Password Admin (kosongkan jika tidak diubah)</label><input type="password" id="set-pass" placeholder="..."></div>
          <button class="btn btn-primary" onclick="saveSetting()">ğŸ’¾ Simpan Pengaturan</button>
        </div>

        <!-- FIREBASE CONFIG CARD in Settings -->
        <div class="card" style="border-color:#f59e0b;">
          <div class="card-title"><div class="ico" style="background:#fef3c7;">ğŸ”¥</div>Konfigurasi Firebase Online
            <span class="card-meta" id="fb-setting-status">â€”</span>
          </div>
          <div id="fb-current-info" style="margin-bottom:.8rem;"></div>
          <div class="fg"><label>API Key</label><input type="text" id="s-fb-apiKey" placeholder="AIzaSy..."></div>
          <div class="fg"><label>Auth Domain</label><input type="text" id="s-fb-authDomain" placeholder="your-project.firebaseapp.com"></div>
          <div class="fg"><label>Project ID</label><input type="text" id="s-fb-projectId" placeholder="your-project-id"></div>
          <div class="fg"><label>Storage Bucket</label><input type="text" id="s-fb-storageBucket" placeholder="your-project.appspot.com"></div>
          <div class="fg"><label>App ID</label><input type="text" id="s-fb-appId" placeholder="1:123456:web:abc..."></div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <button class="btn btn-primary" style="width:auto;padding:.65rem 1.2rem;" onclick="updateFirebaseConfig()">ğŸ”„ Update Config Firebase</button>
            <button class="btn btn-danger btn-sm" onclick="clearFirebaseConfig()">ğŸ—‘ Hapus Config</button>
          </div>
          <div id="fb-update-msg" style="font-size:.78rem;margin-top:.6rem;display:none;padding:.45rem;border-radius:8px;"></div>
        </div>
        
        </div>

        <!-- TOKEN SEKTOR -->
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ”‘</div>Token Sektor (4 Token Tetap)</div>
          <div class="hint" style="margin-bottom:1rem;">Hanya 4 token untuk 4 sektor. Token digunakan pengurus sektor untuk memverifikasi pembayaran tunai anggota sektornya.</div>
          <div id="admin-token-list"></div>
        </div>

        <div class="card" style="border-color:#fca5a5;">
          <div class="card-title" style="color:var(--red);"><div class="ico" style="background:#fee2e2;">âš </div>Zona Berbahaya</div>
          <button class="btn btn-danger btn-sm" onclick="confirmReset()">ğŸ—‘ Hapus Semua Data Pembayaran</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================== DASHBOARD SEKTOR (TOKEN LOGIN) ======================== -->
<div id="token-page" class="page" style="display:none;">
  <!-- TOKEN LOGIN -->
  <div id="token-login-overlay">
    <div style="max-width:400px;margin:3rem auto;padding:0 1rem;animation:fadeUp .4s ease both;">
      <div class="card">
        <div class="login-ico" style="background:linear-gradient(135deg,var(--green),#1A3D28);">ğŸ”‘</div>
        <div class="card-title" style="justify-content:center;border-bottom:none;margin-bottom:.7rem;">Dashboard Sektor</div>
        <p style="text-align:center;color:var(--text-muted);font-family:'Lora',serif;font-style:italic;font-size:.86rem;margin-bottom:1.1rem;">Masukkan token sektor untuk mengakses dashboard</p>
        <div class="fg">
          <label>Token Sektor</label>
          <input type="password" id="tok-login-pass" placeholder="..." onkeydown="if(event.key==='Enter')doTokenLogin()">
          <div id="tok-login-err" style="color:var(--red-light);font-size:.77rem;margin-top:.3rem;display:none;">âŒ Token tidak valid!</div>
        </div>
        <button class="btn btn-green" onclick="doTokenLogin()">Masuk Dashboard Sektor</button>
        <div class="text-center" style="margin-top:.7rem;">
          <button onclick="goPublic()" style="background:none;border:none;color:var(--text-muted);font-size:.79rem;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">â† Kembali</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOKEN DASHBOARD -->
  <div id="token-dashboard" style="display:none;">
    <div class="admin-hdr" id="tok-hdr" style="color:#fff;">
      <div class="admin-hdr-inner">
        <div>
          <h1 id="tok-hdr-title">ğŸ”‘ Dashboard Sektor</h1>
          <p id="tok-hdr-sub">Pengelolaan iuran anggota sektor</p>
          <div id="fb-indicator-token" class="fb-status fb-connecting" style="margin-top:.4rem;display:inline-flex;">â³ Menghubungkan Firebase...</div>
        </div>
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
          <span id="idle-countdown-token" style="font-size:.72rem;color:rgba(255,255,255,.4);"></span>
          <button onclick="goPublic()" style="background:none;border:none;color:rgba(255,255,255,.7);font-size:.79rem;cursor:pointer;font-family:'DM Sans',sans-serif;text-decoration:underline;">â† Ke Halaman Iuran</button>
          <button class="btn btn-outline btn-sm" onclick="doTokenLogout()" style="background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.3);color:#fff;">Keluar</button>
        </div>
      </div>
    </div>
    <div class="admin-tabs" id="tok-tabs">
      <button class="tab-btn active" onclick="switchTokenTab('ttab-tambah',this)">â• Tambah Anggota</button>
      <button class="tab-btn" onclick="switchTokenTab('ttab-rekap',this)">ğŸ“Š Rekap Sektor</button>
      <button class="tab-btn" onclick="switchTokenTab('ttab-konfirmasi',this)">
        âœ“ Konfirmasi
        <span class="notif-dot" id="tok-konfirmasi-dot" style="display:none;">0</span>
      </button>
      <button class="tab-btn" onclick="switchTokenTab('ttab-gs',this)">ğŸ”— Google Sheets</button>
      <button class="tab-btn" onclick="switchTokenTab('ttab-riwayat',this)">ğŸ“‹ Riwayat</button>
    </div>
    <div class="admin-container">
      <div class="stats-row" style="max-width:100%">
        <div class="stat-box"><div class="stat-num" id="t-anggota">0</div><div class="stat-label">Anggota Sektor</div></div>
        <div class="stat-box"><div class="stat-num" id="t-lunas">0</div><div class="stat-label">Lunas</div></div>
        <div class="stat-box"><div class="stat-num pend" id="t-pending">0</div><div class="stat-label">Menunggu</div></div>
      </div>

      <!-- TTAB TAMBAH ANGGOTA -->
      <div id="ttab-tambah" class="tab-content active">
        <div class="card">
          <div class="card-title"><div class="ico">â•</div>Tambah Anggota Sektor</div>
          <div class="hint" style="margin-bottom:.8rem;" id="tok-add-hint">Anggota akan otomatis terdaftar ke sektor Anda</div>
          <div class="fg"><label>Nama Lengkap</label><input type="text" id="tok-new-name" placeholder="Nama anggota..."></div>
          <button class="btn btn-green" onclick="tokAddMember()">Simpan Anggota</button>
        </div>
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ‘¥</div>Daftar Anggota Sektor <span class="card-meta" id="tok-jml-anggota">0 orang</span></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>#</th><th>Nama Anggota</th><th>Dibayar</th><th>Sisa</th><th>Status</th></tr></thead>
              <tbody id="tok-member-tbody"></tbody>
            </table>
          </div>
          <div id="tok-member-empty" class="empty-state" style="display:none;"><div class="esi">ğŸ‘¥</div><p>Belum ada anggota di sektor ini</p></div>
        </div>
      </div>

      <!-- TTAB REKAP -->
      <div id="ttab-rekap" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ“Š</div>Rekap Iuran Sektor <span class="card-meta"><button class="btn btn-outline btn-sm" onclick="exportSektorCSV()">â¬‡ CSV</button></span></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>#</th><th>Nama</th><th>Dibayar</th><th>Sisa</th><th>Progres</th><th>Status</th></tr></thead>
              <tbody id="tok-rekap-tbody"></tbody>
            </table>
          </div>
          <div id="tok-rekap-empty" class="empty-state" style="display:none;"><div class="esi">ğŸ“Š</div><p>Belum ada data</p></div>
        </div>
      </div>

      <!-- TTAB KONFIRMASI -->
      <div id="ttab-konfirmasi" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">â³</div>Konfirmasi Transfer Sektor <span class="card-meta" id="tok-jml-pend">0 pengajuan</span></div>
          <div id="tok-pending-list"></div>
          <div id="tok-pending-empty" class="empty-state" style="display:none;"><div class="esi">âœ“</div><p>Tidak ada pengajuan yang perlu dikonfirmasi</p></div>
        </div>
      </div>

      <!-- TTAB GOOGLE SHEETS -->
      <div id="ttab-gs" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ”—</div>Sinkronisasi Google Sheets</div>
          <div class="gs-box">
            <h3>ğŸŸ¢ Cara Setup</h3>
            <p>Gunakan URL Apps Script yang sama dengan Admin Utama, atau buat yang baru khusus untuk sektor ini.</p>
          </div>
          <div class="fg"><label>Apps Script URL</label><input type="url" id="tok-gs-url" placeholder="https://script.google.com/macros/s/.../exec"></div>
          <div style="display:flex;gap:.5rem;margin-bottom:1rem;">
            <button class="btn btn-gold" style="width:auto;padding:.62rem 1.1rem;" onclick="tokSyncToSheets()">ğŸ”„ Sinkronkan</button>
            <button class="btn btn-outline" onclick="tokSaveGsUrl()">ğŸ’¾ Simpan URL</button>
          </div>
          <div id="tok-sync-status" style="font-size:.77rem;display:none;padding:.5rem;border-radius:8px;"></div>
        </div>
      </div>

      <!-- TTAB RIWAYAT (tidak bisa hapus, hanya admin) -->
      <div id="ttab-riwayat" class="tab-content">
        <div class="card">
          <div class="card-title"><div class="ico">ğŸ“‹</div>Riwayat Pembayaran Sektor</div>
          <div class="info-box" style="margin-bottom:.8rem;">â„¹ï¸ Riwayat hanya dapat dihapus oleh Admin Utama.</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>#</th><th>Nama</th><th>Bulan</th><th>Nominal</th><th>Metode</th><th>Tgl Bayar</th><th>Dikonfirmasi Oleh</th><th>Tgl Konfirmasi</th></tr></thead>
              <tbody id="tok-riwayat-tbody"></tbody>
            </table>
          </div>
          <div id="tok-riwayat-empty" class="empty-state" style="display:none;"><div class="esi">ğŸ“‹</div><p>Belum ada riwayat</p></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>
<script>
// ============================================================
// FIREBASE CONFIG & INIT
// ============================================================
let db = null;
let fbConfig = null;
let fbConnected = false;
const FB_DOC = 'iuran/data'; // Firestore document path

// ============================================================
// AUTO-LOGOUT (idle timer)
// ============================================================
let _idleTimer = null;
let _countdownInterval = null;
const IDLE_SECONDS = (typeof AUTO_LOGOUT_SECONDS !== 'undefined') ? AUTO_LOGOUT_SECONDS : 30;

function updateCountdownDisplay(seconds) {
  ['idle-countdown-admin', 'idle-countdown-token'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (seconds <= 10) {
        el.textContent = `â± Auto-logout: ${seconds}d`;
        el.style.color = 'rgba(255,180,80,.9)';
      } else {
        el.textContent = `â± ${seconds}d`;
        el.style.color = 'rgba(255,255,255,.4)';
      }
    }
  });
}

function resetIdleTimer() {
  clearTimeout(_idleTimer);
  clearInterval(_countdownInterval);
  let remaining = IDLE_SECONDS;
  updateCountdownDisplay(remaining);
  _countdownInterval = setInterval(() => {
    remaining--;
    updateCountdownDisplay(remaining);
    if (remaining <= 0) clearInterval(_countdownInterval);
  }, 1000);
  _idleTimer = setTimeout(() => {
    clearInterval(_countdownInterval);
    if (S.adminLoggedIn) {
      S.adminLoggedIn = false;
      sessionStorage.removeItem('adminLoggedIn');
      goAdmin(); // show login overlay
      toast('â± Sesi berakhir karena tidak aktif.');
    }
    if (S.tokenLoggedIn) {
      S.tokenLoggedIn = false;
      S.currentToken = null;
      sessionStorage.removeItem('tokenLoggedIn');
      sessionStorage.removeItem('currentToken');
      goTokenDashboard(); // show login overlay
      toast('â± Sesi sektor berakhir karena tidak aktif.');
    }
  }, IDLE_SECONDS * 1000);
}

function startIdleWatcher() {
  ['mousemove','mousedown','keydown','touchstart','scroll','click'].forEach(ev => {
    document.addEventListener(ev, resetIdleTimer, { passive: true });
  });
  resetIdleTimer();
}

function withTimeout(promise, ms, label) {
  return new Promise((resolve, reject) => {
    const timer = setTimeout(() => reject(new Error(`Timeout (${ms}ms): ${label}`)), ms);
    promise.then(v => { clearTimeout(timer); resolve(v); }, e => { clearTimeout(timer); reject(e); });
  });
}

async function initFirebase(config) {
  try {
    // Clean up existing app if any
    if (firebase.apps && firebase.apps.length) {
      try { await firebase.app().delete(); } catch(e) {}
    }
    firebase.initializeApp(config);
    db = firebase.firestore();

    // Enable offline persistence (helps with slow connections)
    try {
      await db.enablePersistence({ synchronizeTabs: true });
    } catch(e) {
      // Persistence may already be enabled or not supported â€” ignore
    }

    // Test connection: try to write a ping doc with 10s timeout
    const testWrite = db.collection('iuran').doc('ping').set({ ts: Date.now(), test: true });
    await withTimeout(testWrite, 10000, 'Firebase write test');

    fbConnected = true;
    fbConfig = config;
    console.log('Firebase connected âœ“');
    return true;
  } catch (e) {
    console.error('Firebase init error:', e.message || e);
    fbConnected = false;
    db = null;

    // If it's a persistence error but write succeeded, still consider connected
    if (e && e.code === 'failed-precondition') {
      fbConnected = true;
      return true;
    }
    return false;
  }
}

// Config diambil langsung dari config.js â€” tidak perlu load/save lagi
async function loadFbConfig() {
  if (typeof FIREBASE_CONFIG !== 'undefined' && FIREBASE_CONFIG.apiKey) {
    return FIREBASE_CONFIG;
  }
  return null;
}
async function saveFbConfig(config) { /* tidak digunakan â€” config ada di config.js */ }

function updateFbIndicators(status) {
  // status: 'online' | 'offline' | 'connecting'
  const icons = { online: 'ğŸŸ¢ Firebase Online', offline: 'ğŸ”´ Penyimpanan Lokal', connecting: 'â³ Menghubungkan...' };
  const cls = { online: 'fb-online', offline: 'fb-offline', connecting: 'fb-connecting' };
  ['fb-indicator-admin', 'fb-indicator-token'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = icons[status];
    el.className = 'fb-status ' + cls[status];
  });
  const settingStatus = document.getElementById('fb-setting-status');
  if (settingStatus) settingStatus.textContent = status === 'online' ? 'ğŸŸ¢ Terhubung' : 'ğŸ”´ Tidak terhubung';
}

// ============================================================
// SAVE & LOAD â€” Firebase first, local fallback
// ============================================================
const BULAN=['','Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
const SEKTOR_NAMES={1:'Sektor 1',2:'Sektor 2',3:'Sektor 3',4:'Sektor 4'};
const SEKTOR_COLORS={1:'var(--s1)',2:'var(--s2)',3:'var(--s3)',4:'var(--s4)'};
const SEKTOR_BADGE_CLASS={1:'s1-badge',2:'s2-badge',3:'s3-badge',4:'s4-badge'};

let S={
  members:[],  // {id, nama, sektor}
  payments:[], // {id, nama, sektor, bulan, nominal, metode, tglBayar}
  pending:[],  // {id, nama, sektor, bulan, nominal, noTransfer, catatan, tglSubmit}
  settings:{
    org:'Seksi Bapa',
    tahun:2025,
    nominal:90000,
    password:'admin123',
    tokens:[
      {id:'tok-s1',sektor:1,nama:'Pengurus Sektor 1',token:'SEKTOR1'},
      {id:'tok-s2',sektor:2,nama:'Pengurus Sektor 2',token:'SEKTOR2'},
      {id:'tok-s3',sektor:3,nama:'Pengurus Sektor 3',token:'SEKTOR3'},
      {id:'tok-s4',sektor:4,nama:'Pengurus Sektor 4',token:'SEKTOR4'},
    ],
    gsUrl:''
  },
  adminLoggedIn:false,
  tokenLoggedIn:false,
  currentToken:null // {sektor, nama, token}
};
let mode='transfer';
let selectedSector=0; // for new member form

async function loadState(){
  try {
    if (fbConnected && db) {
      // Load from Firebase
      const doc = await db.collection('iuran').doc('data').get();
      if (doc.exists) {
        const d = doc.data();
        S.members = (d.members || []).map(m => ({...m, sektor: m.sektor || 1}));
        S.payments = (d.payments || []).map(p => ({...p, sektor: p.sektor || getMemberSektorFromList(p.nama, S.members) || 1}));
        S.pending = (d.pending || []).map(p => ({...p, sektor: p.sektor || getMemberSektorFromList(p.nama, S.members) || 1}));
        const ds = d.settings || {};
        S.settings = {...S.settings, ...ds};
        ensureValidTokens();
        return;
      }
    }
  } catch(e) { console.error('Firebase loadState error:', e); }
  // Fallback: local storage
  try {
    let raw = null;
    try { const r = await window.storage.get('iuran-sb-v5'); if (r && r.value) raw = r.value; } catch(e) {}
    if (!raw) { try { const r4 = await window.storage.get('iuran-sb-v4'); if (r4 && r4.value) raw = r4.value; } catch(e) {} }
    if (raw) {
      const d = JSON.parse(raw);
      S.members = (d.members || []).map(m => ({...m, sektor: m.sektor || 1}));
      S.payments = (d.payments || []).map(p => ({...p, sektor: p.sektor || getMemberSektorFromList(p.nama, S.members) || 1}));
      S.pending = (d.pending || []).map(p => ({...p, sektor: p.sektor || getMemberSektorFromList(p.nama, S.members) || 1}));
      const ds = d.settings || {};
      S.settings = {...S.settings, ...ds};
      ensureValidTokens();
      // If Firebase is now connected, migrate local -> Firebase
      if (fbConnected && db) { await save(); }
    }
  } catch(e) { console.error('Local loadState error:', e); }
}

function ensureValidTokens() {
  const existing = S.settings.tokens || [];
  const hasSektor = existing.some(t => t.sektor);
  if (!hasSektor || existing.length !== 4) {
    S.settings.tokens = [
      {id:'tok-s1', sektor:1, nama:'Pengurus Sektor 1', token:'SEKTOR1'},
      {id:'tok-s2', sektor:2, nama:'Pengurus Sektor 2', token:'SEKTOR2'},
      {id:'tok-s3', sektor:3, nama:'Pengurus Sektor 3', token:'SEKTOR3'},
      {id:'tok-s4', sektor:4, nama:'Pengurus Sektor 4', token:'SEKTOR4'},
    ];
  }
}

function getMemberSektorFromList(nama, memberList){
  const m = (memberList||[]).find(x => x.nama && x.nama.toLowerCase() === nama.toLowerCase());
  return m ? m.sektor : 1;
}

async function save(){
  const payload = {
    members: S.members,
    payments: S.payments,
    pending: S.pending,
    settings: S.settings,
    updatedAt: new Date().toISOString()
  };
  // Save to Firebase (primary)
  if (fbConnected && db) {
    try {
      await db.collection('iuran').doc('data').set(payload);
    } catch(e) {
      console.error('Firebase save error:', e);
      fbConnected = false;
      updateFbIndicators('offline');
    }
  }
  // Always save locally as backup
  try {
    await window.storage.set('iuran-sb-v5', JSON.stringify(payload));
  } catch(e) {}
}


// ============================================================
// FIREBASE SETUP & CONFIG MANAGEMENT
// ============================================================
function showSetupPage(){
  ['public-page','admin-page','token-page'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='none';
  });
  document.getElementById('setup-page').style.display='block';
}

async function saveFirebaseConfig(){
  const config = {
    apiKey: document.getElementById('fb-apiKey').value.trim(),
    authDomain: document.getElementById('fb-authDomain').value.trim(),
    projectId: document.getElementById('fb-projectId').value.trim(),
    storageBucket: document.getElementById('fb-storageBucket').value.trim(),
    appId: document.getElementById('fb-appId').value.trim(),
  };
  const errEl = document.getElementById('fb-setup-err');
  const testEl = document.getElementById('fb-setup-testing');
  errEl.style.display='none';

  if (!config.apiKey || !config.projectId) {
    errEl.textContent='âŒ API Key dan Project ID harus diisi!';
    errEl.style.display='block'; return;
  }
  testEl.style.display='block';
  testEl.textContent='â³ Menguji koneksi Firebase... (maks 10 detik)';

  let ok = false;
  try { ok = await initFirebase(config); } catch(e) { console.error('saveFirebaseConfig error:', e); ok = false; }
  testEl.style.display='none';

  if (ok) {
    await saveFbConfig(config);
    await loadState();
    init();
    toast('ğŸ”¥ Firebase berhasil terhubung!');
  } else {
    errEl.innerHTML = 'âŒ Gagal terhubung ke Firebase.<br><small>Pastikan:<br>â€¢ Firestore Database sudah dibuat<br>â€¢ Rules: <code>allow read, write: if true</code><br>â€¢ API Key & Project ID benar<br>â€¢ Buka F12 Console untuk detail error</small>';
    errEl.style.display='block';
  }
}

async function updateFirebaseConfig(){
  const config = {
    apiKey: document.getElementById('s-fb-apiKey').value.trim(),
    authDomain: document.getElementById('s-fb-authDomain').value.trim(),
    projectId: document.getElementById('s-fb-projectId').value.trim(),
    storageBucket: document.getElementById('s-fb-storageBucket').value.trim(),
    appId: document.getElementById('s-fb-appId').value.trim(),
  };
  const msgEl = document.getElementById('fb-update-msg');
  if (!config.apiKey || !config.projectId) {
    msgEl.textContent='âŒ API Key dan Project ID harus diisi!';
    msgEl.style.background='#fee2e2'; msgEl.style.color='var(--red)';
    msgEl.style.display='block'; return;
  }
  msgEl.textContent='â³ Menguji koneksi...';
  msgEl.style.background='#fef3c7'; msgEl.style.color='var(--orange)';
  msgEl.style.display='block';

  const ok = await initFirebase(config);
  if (ok) {
    await saveFbConfig(config);
    updateFbIndicators('online');
    msgEl.textContent='âœ… Firebase berhasil diperbarui dan terhubung!';
    msgEl.style.background='#d1fae5'; msgEl.style.color='#065f46';
    toast('ğŸ”¥ Firebase config diperbarui!');
  } else {
    updateFbIndicators('offline');
    msgEl.textContent='âŒ Gagal terhubung. Periksa config Firebase Anda.';
    msgEl.style.background='#fee2e2'; msgEl.style.color='var(--red)';
  }
}

async function clearFirebaseConfig(){
  if (!confirm('Hapus konfigurasi Firebase? Aplikasi akan beralih ke penyimpanan lokal.')) return;
  try { await window.storage.delete(FB_CONFIG_KEY); } catch(e) {}
  fbConnected = false; db = null; fbConfig = null;
  updateFbIndicators('offline');
  toast('Config Firebase dihapus. Menggunakan penyimpanan lokal.');
}

function useLocalOnly(){
  // Mark that user chose local-only so we don't show setup page again
  saveFbConfig({localOnly: true, apiKey: '', projectId: ''});
  updateFbIndicators('offline');
  loadState().then(()=>init());
}

const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const rp=n=>'Rp '+Number(n).toLocaleString('id-ID');
const tgl=()=>new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});
const wkt=()=>new Date().toLocaleString('id-ID',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});

function getPaid(nama){return S.payments.filter(p=>p.nama.toLowerCase()===nama.toLowerCase()).reduce((s,p)=>s+Number(p.nominal),0);}
function getSisa(nama){return Math.max(0,S.settings.nominal-getPaid(nama));}
function isLunas(nama){return getSisa(nama)===0;}
function getMember(nama){return S.members.find(m=>m.nama.toLowerCase()===nama.toLowerCase());}
function findToken(val){return S.settings.tokens.find(t=>t.token===val);}
function getMemberSektor(sektor){return S.members.filter(m=>m.sektor===sektor);}

function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

function sektorBadge(sektor){
  if(!sektor||!SEKTOR_NAMES[sektor]) return '';
  const cl=SEKTOR_BADGE_CLASS[sektor]||'';
  return '<span class="sector-badge '+cl+'">'+SEKTOR_NAMES[sektor]+'</span>';
}

// ============ ROUTING ============
function init(){
  // Restore session dari sessionStorage (persist saat refresh)
  if (sessionStorage.getItem('adminLoggedIn') === '1') {
    S.adminLoggedIn = true;
  }
  if (sessionStorage.getItem('tokenLoggedIn') === '1') {
    S.tokenLoggedIn = true;
    try { S.currentToken = JSON.parse(sessionStorage.getItem('currentToken')); } catch(e) {}
  }

  // Tentukan halaman yang ditampilkan berdasarkan session aktif
  if (S.adminLoggedIn) {
    goAdmin();
  } else if (S.tokenLoggedIn && S.currentToken) {
    goTokenDashboard();
  } else {
    document.getElementById('public-page').style.display='block';
    document.getElementById('admin-page').style.display='none';
    document.getElementById('token-page').style.display='none';
    renderPubStats();
  }

  setupAC('inp-nama','ac-nama');
  setupAC('cek-nama','ac-cek');
  updateBadge();updateHint();
  startIdleWatcher();
}
function goPublic(){
  document.getElementById('public-page').style.display='block';
  document.getElementById('admin-page').style.display='none';
  document.getElementById('token-page').style.display='none';
  renderPubStats();updateBadge();
}
function goAdmin(){
  document.getElementById('public-page').style.display='none';
  document.getElementById('admin-page').style.display='block';
  document.getElementById('token-page').style.display='none';
  if(S.adminLoggedIn){
    document.getElementById('login-overlay').style.display='none';
    document.getElementById('admin-dashboard').style.display='block';
    loadSettings();renderAdmin();
  }else{
    document.getElementById('login-overlay').style.display='block';
    document.getElementById('admin-dashboard').style.display='none';
    document.getElementById('admin-pass').value='';
    document.getElementById('pass-err').style.display='none';
  }
}
function goTokenDashboard(){
  document.getElementById('public-page').style.display='none';
  document.getElementById('admin-page').style.display='none';
  document.getElementById('token-page').style.display='block';
  if(S.tokenLoggedIn&&S.currentToken){
    document.getElementById('token-login-overlay').style.display='none';
    document.getElementById('token-dashboard').style.display='block';
    renderTokenDashboard();
  }else{
    document.getElementById('token-login-overlay').style.display='block';
    document.getElementById('token-dashboard').style.display='none';
    document.getElementById('tok-login-pass').value='';
    document.getElementById('tok-login-err').style.display='none';
  }
}
function updateBadge(){document.getElementById('badge-tahun').textContent='ğŸ“… Iuran Tahun '+S.settings.tahun+' Â· '+rp(S.settings.nominal)+'/Tahun';}

// ============ MODE TOGGLE ============
function setMode(m){
  mode=m;
  document.getElementById('mbtn-transfer').classList.toggle('active',m==='transfer');
  document.getElementById('mbtn-token').classList.toggle('active',m==='token');
  document.getElementById('sec-transfer').style.display=m==='transfer'?'block':'none';
  document.getElementById('sec-token').style.display=m==='token'?'block':'none';
  document.getElementById('mode-info').innerHTML=m==='transfer'
    ?'ğŸ¦ <strong>Mode Transfer:</strong> Isi nama, nominal dan nomor Dana/OVO. Admin akan memverifikasi.'
    :'ğŸ”‘ <strong>Mode Token Sektor:</strong> Token dari pengurus sektor. Pembayaran langsung terverifikasi.';
  document.getElementById('mode-info').className='info-box';
  document.getElementById('result-box').style.display='none';
}

// ============ TOKEN LIVE CHECK ============
function cekTokenLive(el){
  const v=el.value,st=document.getElementById('token-status');
  if(!v){el.className='inp-token';st.innerHTML='ğŸ”‘ Token diberikan oleh pengurus sektor';st.style.color='';return;}
  const found=findToken(v);
  if(found){
    el.className='inp-token token-valid';
    st.innerHTML='<span class="tbadge tbadge-ok">âœ“ Token valid â€” Pengurus '+SEKTOR_NAMES[found.sektor]+'</span>';
  }else{
    el.className='inp-token token-invalid';
    st.innerHTML='<span class="tbadge tbadge-err">âœ— Token tidak valid</span>';
  }
}

// ============ AUTOCOMPLETE ============
function setupAC(inpId,lstId){
  const inp=document.getElementById(inpId),lst=document.getElementById(lstId);
  if(!inp||!lst)return;
  inp.addEventListener('input',()=>{
    const q=inp.value.trim().toLowerCase();
    if(!q){lst.classList.remove('show');return;}
    const ms=S.members.filter(m=>m.nama.toLowerCase().includes(q));
    if(!ms.length){lst.classList.remove('show');return;}
    lst.innerHTML=ms.map(mm=>{
      const l=isLunas(mm.nama);
      return '<div class="ac-item" onclick="pickAC(\''+inpId+'\',\''+lstId+'\',\''+mm.nama.replace(/'/g,"\\'")+'\')">'+
        '<span>'+mm.nama+' '+sektorBadge(mm.sektor)+'</span>'+
        (l?'<span class="badge badge-lunas">Lunas</span>':'<span style="font-size:.72rem;color:var(--text-muted)">'+rp(getSisa(mm.nama))+' lagi</span>')+
        '</div>';
    }).join('');
    lst.classList.add('show');
  });
  document.addEventListener('click',e=>{if(!inp.contains(e.target)&&!lst.contains(e.target))lst.classList.remove('show');});
}
function pickAC(inpId,lstId,nama){
  document.getElementById(inpId).value=nama;
  document.getElementById(lstId).classList.remove('show');
  if(inpId==='inp-nama'){updateHint();showNamaSectorInfo(nama);}
}
function showNamaSectorInfo(nama){
  const m=getMember(nama);
  const el=document.getElementById('nama-sector-info');
  if(!el)return;
  if(m){el.innerHTML=sektorBadge(m.sektor)+'<span style="font-size:.75rem;color:var(--text-muted);margin-left:.3rem;">Terdaftar di '+SEKTOR_NAMES[m.sektor]+'</span>';}
  else{el.innerHTML='';}
}
function onNamaInput(){
  updateHint();
  const nama=document.getElementById('inp-nama').value.trim();
  showNamaSectorInfo(nama);
}
function updateHint(){
  const nama=document.getElementById('inp-nama')&&document.getElementById('inp-nama').value.trim();
  const nominal=parseInt((document.getElementById('inp-nominal')&&document.getElementById('inp-nominal').value)||'0');
  const hint=document.getElementById('sisa-hint');
  if(!hint)return;
  if(nama&&getMember(nama)){
    const paid=getPaid(nama),sisa=getSisa(nama);
    if(sisa===0){hint.innerHTML='<strong style="color:var(--green)">'+nama+' sudah LUNAS!</strong> Tidak perlu bayar lagi.';return;}
    if(nominal>0){
      const proj=Math.max(0,S.settings.nominal-(paid+nominal));
      hint.innerHTML=proj===0?'âœ… Dengan pembayaran ini <strong>'+nama+'</strong> akan <strong style="color:var(--green)">LUNAS!</strong>'
        :'Sudah bayar: '+rp(paid)+' â€” Setelah ini sisa: <strong style="color:var(--red-light)">'+rp(proj)+'</strong>';
    }else{
      hint.innerHTML=nama+' sudah bayar '+rp(paid)+' â€” Sisa: <strong style="color:var(--red-light)">'+rp(sisa)+'</strong>';
    }
  }else{
    hint.innerHTML='ğŸ’¡ Iuran setahun penuh = '+rp(S.settings.nominal);
  }
}

function renderPubStats(){
  document.getElementById('s-anggota').textContent=S.members.length;
  document.getElementById('s-lunas').textContent=S.members.filter(m=>isLunas(m.nama)).length;
  document.getElementById('s-pending').textContent=S.pending.length;
}

// ============ SUBMIT PAYMENT (PUBLIC) ============
function submitPayment(){
  const nama=document.getElementById('inp-nama').value.trim();
  const bulan=document.getElementById('inp-bulan').value;
  const nominal=parseInt(document.getElementById('inp-nominal').value||'0');
  const rb=document.getElementById('result-box');
  if(!nama){toast('Masukkan nama anggota!');return;}
  const member=getMember(nama);
  if(!member){toast('Nama tidak ada dalam daftar anggota!');return;}
  if(!bulan){toast('Pilih bulan pembayaran!');return;}
  if(!nominal||nominal<=0){toast('Masukkan nominal yang valid!');return;}
  const sisaBefore=getSisa(nama),paidBefore=getPaid(nama);
  if(sisaBefore===0){
    showResult(rb,'lunas','Iuran Sudah Lunas!',nama+' sudah LUNAS iuran '+S.settings.tahun+'. Tidak perlu ada pembayaran tambahan.','Total: '+rp(paidBefore)+' (lunas)');
    toast('Iuran sudah lunas');return;
  }
  const totalBaru=paidBefore+nominal,sisaBaru=Math.max(0,S.settings.nominal-totalBaru),nowLunas=sisaBaru===0;
  if(mode==='token'){
    const tok=document.getElementById('inp-token').value.trim();
    if(!tok){toast('Masukkan token pengurus!');return;}
    const foundTok=findToken(tok);
    if(!foundTok){toast('Token tidak valid!');return;}
    // VALIDASI: token harus sesuai sektor anggota
    if(foundTok.sektor!==member.sektor){
      showResult(rb,'error','âš  Token Salah!',
        'âŒ Token Salah! Nama <strong>'+nama+'</strong> terdaftar di <strong>'+SEKTOR_NAMES[member.sektor]+'</strong>, bukan '+SEKTOR_NAMES[foundTok.sektor]+'. Gunakan token '+SEKTOR_NAMES[member.sektor]+' yang sesuai.','');
      document.getElementById('result-box').style.display='block';
      document.getElementById('res-title').className='res-title error';
      toast('âš  Token salah! '+nama+' adalah '+SEKTOR_NAMES[member.sektor]);
      document.getElementById('inp-token').className='inp-token token-invalid';
      return;
    }
    S.payments.push({id:uid(),nama,sektor:member.sektor,bulan:parseInt(bulan),nominal,metode:'Tunai',tglBayar:tgl(),tglKonfirmasi:wkt(),dikonfirmasiOleh:foundTok.nama+' ('+SEKTOR_NAMES[foundTok.sektor]+')',tipeKonfirmasi:'token'});
    save();renderPubStats();autoSync();
    if(nowLunas){
      showResult(rb,'lunas','LUNAS! ğŸ‰','Iuran '+S.settings.tahun+' untuk <strong>'+nama+'</strong> ('+SEKTOR_NAMES[member.sektor]+') sudah LUNAS. Diverifikasi oleh '+foundTok.nama+'.','Total: '+rp(totalBaru)+' (lunas)');
      toast('LUNAS! Pembayaran dicatat!');
    }else{
      showResult(rb,'belum','Pembayaran Dicatat','Terima kasih <strong>'+nama+'</strong>! Pembayaran '+BULAN[parseInt(bulan)]+' sebesar '+rp(nominal)+' diverifikasi oleh '+foundTok.nama+'.','Sisa iuran: '+rp(sisaBaru));
      toast('Dicatat! Sisa: '+rp(sisaBaru));
    }
    document.getElementById('inp-token').value='';
    document.getElementById('inp-token').className='inp-token';
    document.getElementById('token-status').innerHTML='ğŸ”‘ Token diberikan oleh pengurus sektor';
  }else{
    const notr=document.getElementById('inp-notr').value.trim();
    const cat=document.getElementById('inp-catatan').value.trim();
    if(!notr){toast('Masukkan nomor Dana/OVO!');return;}
    if(notr.length<9){toast('Nomor tidak valid (min. 9 digit)!');return;}
    S.pending.push({id:uid(),nama,sektor:member.sektor,bulan:parseInt(bulan),nominal,noTransfer:notr,catatan:cat,tglSubmit:wkt()});
    save();renderPubStats();autoSync();
    showResult(rb,'pending','Pengajuan Terkirim! ğŸ“¤','Pengajuan <strong>'+nama+'</strong> ('+SEKTOR_NAMES[member.sektor]+') bulan '+BULAN[parseInt(bulan)]+' sebesar '+rp(nominal)+' dari '+notr+' sudah diterima. Menunggu konfirmasi admin.','');
    toast('Pengajuan terkirim! Menunggu konfirmasi.');
    document.getElementById('inp-notr').value='';document.getElementById('inp-catatan').value='';
  }
  document.getElementById('inp-nominal').value='';updateHint();
}

function showResult(rb,cls,title,msg,nom){
  rb.style.display='block';rb.className=cls;
  rb.innerHTML='<div class="res-icon">'+(cls==='lunas'?'âœ…':cls==='belum'?'ğŸ“':cls==='pending'?'â³':'âš ï¸')+'</div>'
    +'<div class="res-title '+cls+'">'+title+'</div>'
    +'<div class="res-msg">'+msg+'</div>'
    +(nom?'<div class="res-nom">'+nom+'</div>':'');
}

// ============ CEK STATUS ============
function cekStatus(){
  const nama=document.getElementById('cek-nama').value.trim();
  const el=document.getElementById('cek-result');
  if(!nama){toast('Masukkan nama!');return;}
  const member=getMember(nama);
  if(!member){el.innerHTML='<div class="info-box" style="background:#fee2e2;border-color:#fca5a5;color:var(--red);">âŒ Nama <strong>'+nama+'</strong> tidak ditemukan dalam daftar anggota.</div>';return;}
  const paid=getPaid(nama),sisa=getSisa(nama),lunas=sisa===0,pct=Math.min(100,Math.round(paid/S.settings.nominal*100));
  const pends=S.pending.filter(p=>p.nama.toLowerCase()===nama.toLowerCase());
  el.innerHTML='<div style="background:'+(lunas?'linear-gradient(135deg,#d1fae5,#a7f3d0)':'linear-gradient(135deg,#fef3c7,#fde68a)')+';border:1.5px solid '+(lunas?'#34d399':'var(--gold)')+';border-radius:12px;padding:1.1rem;animation:pop .4s ease both;">'
    +'<div style="font-family:\'Playfair Display\',serif;font-size:1rem;font-weight:700;color:'+(lunas?'var(--green)':'var(--gold-dark)')+';">'+(lunas?'âœ… Sudah Lunas!':'â³ Belum Lunas')+'</div>'
    +'<div style="font-size:.82rem;color:var(--text-muted);margin-top:.2rem;">'+nama+' Â· '+SEKTOR_NAMES[member.sektor]+'</div>'
    +'<div style="display:flex;justify-content:space-between;margin-top:.7rem;font-size:.84rem;">'
    +'<span>Terbayar: <strong>'+rp(paid)+'</strong></span>'
    +'<span>Sisa: <strong style="color:'+(lunas?'var(--green)':'var(--red-light)')+'">'+(lunas?'â€”':rp(sisa))+'</strong></span></div>'
    +'<div class="prog-wrap" style="height:8px;margin-top:.5rem;"><div class="prog-fill '+(lunas?'':'partial')+'" style="width:'+pct+'%"></div></div>'
    +'<div style="text-align:right;font-size:.67rem;color:var(--text-muted);margin-top:2px;">'+pct+'%</div>'
    +(pends.length?'<div style="margin-top:.6rem;font-size:.76rem;background:#dbeafe;border-radius:8px;padding:.4rem .7rem;color:#1e40af;">Ada '+pends.length+' pengajuan menunggu konfirmasi admin</div>':'')
    +'</div>';
}

// ============ ADMIN LOGIN ============
function doLogin(){
  try{
    const p=document.getElementById('admin-pass').value;
    if(p===S.settings.password){
      S.adminLoggedIn=true;
      sessionStorage.setItem('adminLoggedIn','1');
      document.getElementById('pass-err').style.display='none';
      document.getElementById('login-overlay').style.display='none';
      document.getElementById('admin-dashboard').style.display='block';
      try{ loadSettings(); }catch(e){ console.error('loadSettings error',e); }
      try{ renderAdmin(); }catch(e){ console.error('renderAdmin error',e); }
      resetIdleTimer();
    }else{
      document.getElementById('pass-err').style.display='block';
      document.getElementById('admin-pass').value='';
    }
  }catch(e){ console.error('doLogin error:',e); toast('Error: '+e.message); }
}
function doLogout(){
  S.adminLoggedIn=false;
  sessionStorage.removeItem('adminLoggedIn');
  // Tetap di halaman admin, tampilkan overlay login
  document.getElementById('login-overlay').style.display='block';
  document.getElementById('admin-dashboard').style.display='none';
  document.getElementById('admin-pass').value='';
  document.getElementById('pass-err').style.display='none';
}

// ============ TOKEN DASHBOARD LOGIN ============
function doTokenLogin(){
  try{
    const p=document.getElementById('tok-login-pass').value;
    const found=findToken(p);
    if(found){
      S.tokenLoggedIn=true;S.currentToken=found;
      sessionStorage.setItem('tokenLoggedIn','1');
      sessionStorage.setItem('currentToken',JSON.stringify(found));
      document.getElementById('tok-login-err').style.display='none';
      document.getElementById('token-login-overlay').style.display='none';
      document.getElementById('token-dashboard').style.display='block';
      try{ renderTokenDashboard(); }catch(e){ console.error('renderTokenDashboard error',e); }
      resetIdleTimer();
    }else{
      document.getElementById('tok-login-err').style.display='block';
      document.getElementById('tok-login-pass').value='';
    }
  }catch(e){ console.error('doTokenLogin error:',e); toast('Error: '+e.message); }
}
function doTokenLogout(){
  S.tokenLoggedIn=false;S.currentToken=null;
  sessionStorage.removeItem('tokenLoggedIn');
  sessionStorage.removeItem('currentToken');
  // Tetap di halaman token, tampilkan overlay login
  document.getElementById('token-login-overlay').style.display='block';
  document.getElementById('token-dashboard').style.display='none';
  document.getElementById('tok-login-pass').value='';
  document.getElementById('tok-login-err').style.display='none';
}

// ============ ADMIN TABS ============
function switchAdminTab(tabId,btn){
  document.querySelectorAll('#admin-dashboard .tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#admin-dashboard .tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');btn.classList.add('active');
}
function switchTokenTab(tabId,btn){
  document.querySelectorAll('#token-dashboard .tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#token-dashboard .tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');btn.classList.add('active');
}

// ============ SECTOR SELECT (ADMIN ADD MEMBER) ============
function selectSector(n,btn){
  selectedSector=n;
  document.querySelectorAll('#new-member-sector-row .ss-btn').forEach(b=>{
    b.className='ss-btn';
  });
  btn.classList.add('active-s'+n);
}

// ============ RENDER ADMIN ============
function renderAdmin(){
  try{ renderAdminStats(); }catch(e){ console.error('renderAdminStats',e); }
  try{ renderSektorAnggota(); }catch(e){ console.error('renderSektorAnggota',e); }
  try{ renderPending(); }catch(e){ console.error('renderPending',e); }
  try{ renderRekapTable(); }catch(e){ console.error('renderRekapTable',e); }
  try{ renderAdminRiwayatTable(); }catch(e){ console.error('renderAdminRiwayatTable',e); }
}
function renderAdminStats(){
  const total=S.members.length,lunas=S.members.filter(m=>isLunas(m.nama)).length;
  const terk=S.payments.reduce((s,p)=>s+Number(p.nominal),0),pend=S.pending.length;
  document.getElementById('a-anggota').textContent=total;
  document.getElementById('a-lunas').textContent=lunas;
  document.getElementById('a-terkumpul').textContent=rp(terk);
  document.getElementById('a-pending').textContent=pend;
  const dot=document.getElementById('admin-konfirmasi-dot');
  dot.style.display=pend>0?'flex':'none';dot.textContent=pend;
  document.getElementById('jml-pend-lbl').textContent=pend+' pengajuan';
  renderPubStats();
}

function renderSektorAnggota(){
  const c=document.getElementById('sektor-anggota-container');
  let html='';
  [1,2,3,4].forEach(sek=>{
    const members=getMemberSektor(sek);
    html+='<div class="card"><div class="card-title" style="color:'+SEKTOR_COLORS[sek]+'">'
      +'<div class="ico" style="background:'+(sek===1?'#dbeafe':sek===2?'#d1fae5':sek===3?'#ede9fe':'#ffedd5')+';">ğŸ˜</div>'
      +SEKTOR_NAMES[sek]+' <span class="card-meta">'+members.length+' anggota</span></div>';
    if(!members.length){
      html+='<div class="empty-state" style="padding:1rem;"><p>Belum ada anggota di sektor ini</p></div>';
    }else{
      html+='<div class="table-wrap"><table><thead><tr><th>#</th><th>Nama Anggota</th><th>Dibayar</th><th>Sisa</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
      members.forEach((m,i)=>{
        const paid=getPaid(m.nama),sisa=getSisa(m.nama),lunas=sisa===0,pend=S.pending.filter(p=>p.nama.toLowerCase()===m.nama.toLowerCase()).length;
        html+='<tr><td style="color:var(--text-muted);font-size:.75rem">'+(i+1)+'</td>'
          +'<td><span class="nc">'+m.nama+'</span>'+(pend?'<span class="badge badge-pending" style="margin-left:.35rem">'+pend+'</span>':'')+'</td>'
          +'<td>'+rp(paid)+'</td>'
          +'<td style="color:'+(lunas?'var(--green)':'var(--red-light)')+'"><strong>'+(lunas?'Lunas':rp(sisa))+'</strong></td>'
          +'<td><span class="badge '+(lunas?'badge-lunas':'badge-belum')+'">'+(lunas?'Lunas':'Belum')+'</span></td>'
          +'<td><button class="btn btn-danger btn-sm" onclick="deleteMember(\''+m.id+'\')">Hapus</button></td></tr>';
      });
      html+='</tbody></table></div>';
    }
    html+='</div>';
  });
  c.innerHTML=html;
}

function renderPending(){
  const list=document.getElementById('pending-list'),empty=document.getElementById('pending-empty');
  if(!S.pending.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=S.pending.map(p=>{
    const paidBef=getPaid(p.nama),sisaBef=getSisa(p.nama);
    const sisaJika=Math.max(0,S.settings.nominal-(paidBef+p.nominal)),akanLunas=sisaJika===0,sudahLunas=sisaBef===0;
    return '<div class="pcard">'
      +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:.7rem;flex-wrap:wrap;">'
      +'<div style="flex:1"><div class="pcard-name">'+p.nama+' '+sektorBadge(p.sektor)+'</div>'
      +'<div class="pcard-detail">Bulan: <strong>'+BULAN[p.bulan]+'</strong> Â· Nominal: <strong>'+rp(p.nominal)+'</strong><br>'
      +'No. Transfer: <strong>'+p.noTransfer+'</strong>'+(p.catatan?'<br>Catatan: '+p.catatan:'')+'<br>Diajukan: '+p.tglSubmit+'</div>'
      +(sudahLunas?'<div style="font-size:.77rem;background:#fef3c7;padding:.3rem .6rem;border-radius:7px;margin-top:.4rem;">'+p.nama+' sudah LUNAS</div>'
        :'<div style="font-size:.77rem;background:'+(akanLunas?'#d1fae5':'#fef3c7')+';padding:.3rem .6rem;border-radius:7px;margin-top:.4rem;">'
        +(akanLunas?'Jika dikonfirmasi: LUNAS':'Sisa jika dikonfirmasi: '+rp(sisaJika))+'</div>')
      +'</div><span class="badge badge-pending">Menunggu</span></div>'
      +'<div class="pcard-actions"><button class="btn btn-confirm btn-sm" onclick="confirmPending(\''+p.id+'\',false)">ğŸ”’ Konfirmasi (Admin)</button><button class="btn btn-reject btn-sm" onclick="rejectPending(\''+p.id+'\')">Tolak</button></div></div>';
  }).join('');
}

function renderRekapTable(filterSektor=0){
  const tbody=document.getElementById('rekap-tbody'),empty=document.getElementById('rekap-empty');
  let ms=filterSektor?S.members.filter(m=>m.sektor===filterSektor):S.members;
  if(!ms.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=ms.map((m,i)=>{
    const paid=getPaid(m.nama),sisa=getSisa(m.nama),lunas=sisa===0,pct=Math.min(100,Math.round(paid/S.settings.nominal*100));
    return '<tr><td style="color:var(--text-muted);font-size:.75rem">'+(i+1)+'</td>'
      +'<td><span class="nc">'+m.nama+'</span></td>'
      +'<td>'+sektorBadge(m.sektor)+'</td>'
      +'<td><strong>'+rp(paid)+'</strong></td>'
      +'<td style="color:'+(lunas?'var(--green)':'var(--red-light)')+'"><strong>'+(lunas?'â€”':rp(sisa))+'</strong></td>'
      +'<td><div class="prog-wrap"><div class="prog-fill '+(lunas?'':'partial')+'" style="width:'+pct+'%"></div></div><div style="font-size:.65rem;color:var(--text-muted);margin-top:2px">'+pct+'%</div></td>'
      +'<td><span class="badge '+(lunas?'badge-lunas':'badge-belum')+'">'+(lunas?'Lunas':'Belum')+'</span></td></tr>';
  }).join('');
}
function filterRekap(n){renderRekapTable(n);}

function renderAdminRiwayatTable(){
  const tbody=document.getElementById('admin-riwayat-tbody'),empty=document.getElementById('admin-riwayat-empty');
  const sorted=[...S.payments].reverse();
  if(!sorted.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=sorted.map((p,i)=>{
    const isAdmin=p.tipeKonfirmasi==='admin';
    const isTunai=p.metode==='Tunai';
    const konfIcon=isAdmin?'ğŸ”’':isTunai?'ğŸ”‘':'âœ…';
    const konfColor=isAdmin?'var(--brown)':isTunai?'var(--green)':'var(--blue)';
    const konfBg=isAdmin?'#fef3c7':isTunai?'#d1fae5':'#dbeafe';
    return '<tr><td style="color:var(--text-muted);font-size:.75rem">'+(i+1)+'</td>'
      +'<td><span class="nc">'+p.nama+'</span></td>'
      +'<td>'+sektorBadge(p.sektor||0)+'</td>'
      +'<td>'+BULAN[p.bulan]+'</td>'
      +'<td><strong>'+rp(p.nominal)+'</strong></td>'
      +'<td><span style="display:inline-flex;align-items:center;gap:.3rem;font-size:.73rem;background:'+(p.metode==='Transfer'?'#dbeafe':'#d1fae5')+';color:'+(p.metode==='Transfer'?'#1e40af':'#065f46')+';padding:.15rem .5rem;border-radius:8px;font-weight:600;">'+(p.metode==='Transfer'?'ğŸ¦ Transfer':'ğŸ’µ Tunai')+(p.noTransfer?' Â· '+p.noTransfer:'')+'</span></td>'
      +'<td style="font-size:.78rem;color:var(--text-muted);">'+p.tglBayar+'</td>'
      +'<td><span style="display:inline-flex;align-items:center;gap:.25rem;font-size:.72rem;background:'+konfBg+';color:'+konfColor+';padding:.15rem .5rem;border-radius:8px;font-weight:600;white-space:nowrap;">'+konfIcon+' '+(p.dikonfirmasiOleh||'â€”')+'</span></td>'
      +'<td style="font-size:.75rem;color:var(--text-muted);white-space:nowrap;">'+(p.tglKonfirmasi||p.tglBayar||'â€”')+'</td></tr>';
  }).join('');
}

function adminHapusRiwayat(){
  if(!confirm('Hapus SEMUA riwayat pembayaran? Data tidak bisa dikembalikan!'))return;
  S.payments=[];save();renderAdmin();toast('Semua riwayat dihapus!');
}

// ============ TOKEN DASHBOARD RENDER ============
function renderTokenDashboard(){
  if(!S.currentToken)return;
  const tok=S.currentToken,sek=tok.sektor;
  const sColors={1:'#1B4F8A',2:'#2D5A3D',3:'#6B2D8B',4:'#8B3A0F'};
  const hdr=document.getElementById('tok-hdr');
  hdr.style.background='linear-gradient(135deg,'+sColors[sek]+', #1a1a1a)';
  document.getElementById('tok-hdr-title').textContent='ğŸ”‘ Dashboard '+SEKTOR_NAMES[sek];
  document.getElementById('tok-hdr-sub').textContent='Diakses oleh: '+tok.nama;
  document.getElementById('tok-add-hint').textContent='Anggota akan otomatis terdaftar ke '+SEKTOR_NAMES[sek];
  // Load GS URL
  const tokGsEl=document.getElementById('tok-gs-url'); if(tokGsEl) tokGsEl.value=S.settings.gsUrl||'';
  renderTokStats();renderTokMemberTable();renderTokRekapTable();renderTokPending();renderTokRiwayat();
}

function renderTokStats(){
  const sek=S.currentToken.sektor;
  const ms=getMemberSektor(sek);
  const pends=S.pending.filter(p=>p.sektor===sek);
  document.getElementById('t-anggota').textContent=ms.length;
  document.getElementById('t-lunas').textContent=ms.filter(m=>isLunas(m.nama)).length;
  document.getElementById('t-pending').textContent=pends.length;
  const dot=document.getElementById('tok-konfirmasi-dot');
  dot.style.display=pends.length>0?'flex':'none';dot.textContent=pends.length;
  document.getElementById('tok-jml-pend').textContent=pends.length+' pengajuan';
}

function renderTokMemberTable(){
  const sek=S.currentToken.sektor;
  const ms=getMemberSektor(sek);
  const tbody=document.getElementById('tok-member-tbody'),empty=document.getElementById('tok-member-empty');
  document.getElementById('tok-jml-anggota').textContent=ms.length+' orang';
  if(!ms.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=ms.map((m,i)=>{
    const paid=getPaid(m.nama),sisa=getSisa(m.nama),lunas=sisa===0;
    return '<tr><td style="color:var(--text-muted);font-size:.75rem">'+(i+1)+'</td>'
      +'<td><span class="nc">'+m.nama+'</span></td>'
      +'<td>'+rp(paid)+'</td>'
      +'<td style="color:'+(lunas?'var(--green)':'var(--red-light)')+'"><strong>'+(lunas?'Lunas':rp(sisa))+'</strong></td>'
      +'<td><span class="badge '+(lunas?'badge-lunas':'badge-belum')+'">'+(lunas?'Lunas':'Belum')+'</span></td></tr>';
  }).join('');
}

function renderTokRekapTable(){
  const sek=S.currentToken.sektor;
  const ms=getMemberSektor(sek);
  const tbody=document.getElementById('tok-rekap-tbody'),empty=document.getElementById('tok-rekap-empty');
  if(!ms.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=ms.map((m,i)=>{
    const paid=getPaid(m.nama),sisa=getSisa(m.nama),lunas=sisa===0,pct=Math.min(100,Math.round(paid/S.settings.nominal*100));
    return '<tr><td style="color:var(--text-muted);font-size:.75rem">'+(i+1)+'</td>'
      +'<td><span class="nc">'+m.nama+'</span></td>'
      +'<td><strong>'+rp(paid)+'</strong></td>'
      +'<td style="color:'+(lunas?'var(--green)':'var(--red-light)')+'"><strong>'+(lunas?'â€”':rp(sisa))+'</strong></td>'
      +'<td><div class="prog-wrap"><div class="prog-fill '+(lunas?'':'partial')+'" style="width:'+pct+'%"></div></div><div style="font-size:.65rem;color:var(--text-muted);margin-top:2px">'+pct+'%</div></td>'
      +'<td><span class="badge '+(lunas?'badge-lunas':'badge-belum')+'">'+(lunas?'Lunas':'Belum')+'</span></td></tr>';
  }).join('');
}

function renderTokPending(){
  const sek=S.currentToken.sektor;
  const pends=S.pending.filter(p=>p.sektor===sek);
  const list=document.getElementById('tok-pending-list'),empty=document.getElementById('tok-pending-empty');
  if(!pends.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=pends.map(p=>{
    const sisaJika=Math.max(0,S.settings.nominal-(getPaid(p.nama)+p.nominal)),akanLunas=sisaJika===0;
    return '<div class="pcard"><div style="display:flex;align-items:flex-start;justify-content:space-between;gap:.7rem;flex-wrap:wrap;">'
      +'<div style="flex:1"><div class="pcard-name">'+p.nama+'</div>'
      +'<div class="pcard-detail">Bulan: <strong>'+BULAN[p.bulan]+'</strong> Â· Nominal: <strong>'+rp(p.nominal)+'</strong><br>'
      +'No. Transfer: <strong>'+p.noTransfer+'</strong>'+(p.catatan?'<br>Catatan: '+p.catatan:'')+'<br>Diajukan: '+p.tglSubmit+'</div>'
      +'<div style="font-size:.77rem;background:'+(akanLunas?'#d1fae5':'#fef3c7')+';padding:.3rem .6rem;border-radius:7px;margin-top:.4rem;">'
      +(akanLunas?'Jika dikonfirmasi: LUNAS':'Sisa jika dikonfirmasi: '+rp(sisaJika))+'</div></div>'
      +'<span class="badge badge-pending">Menunggu</span></div>'
      +'<div class="pcard-actions"><button class="btn btn-confirm btn-sm" onclick="confirmPending(\''+p.id+'\',true)">ğŸ”‘ Konfirmasi (Sektor)</button><button class="btn btn-reject btn-sm" onclick="rejectPending(\''+p.id+'\')">Tolak</button></div></div>';
  }).join('');
}

function renderTokRiwayat(){
  const sek=S.currentToken.sektor;
  const payments=S.payments.filter(p=>p.sektor===sek);
  const sorted=[...payments].reverse();
  const tbody=document.getElementById('tok-riwayat-tbody'),empty=document.getElementById('tok-riwayat-empty');
  if(!sorted.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=sorted.map((p,i)=>{
    const isAdmin=p.tipeKonfirmasi==='admin';
    const isTunai=p.metode==='Tunai';
    const konfIcon=isAdmin?'ğŸ”’':isTunai?'ğŸ”‘':'âœ…';
    const konfColor=isAdmin?'var(--brown)':isTunai?'var(--green)':'var(--blue)';
    const konfBg=isAdmin?'#fef3c7':isTunai?'#d1fae5':'#dbeafe';
    return '<tr><td style="color:var(--text-muted);font-size:.75rem">'+(i+1)+'</td>'
      +'<td><span class="nc">'+p.nama+'</span></td>'
      +'<td>'+BULAN[p.bulan]+'</td>'
      +'<td><strong>'+rp(p.nominal)+'</strong></td>'
      +'<td><span style="display:inline-flex;align-items:center;gap:.3rem;font-size:.73rem;background:'+(p.metode==='Transfer'?'#dbeafe':'#d1fae5')+';color:'+(p.metode==='Transfer'?'#1e40af':'#065f46')+';padding:.15rem .5rem;border-radius:8px;font-weight:600;">'+(p.metode==='Transfer'?'ğŸ¦ Transfer':'ğŸ’µ Tunai')+(p.noTransfer?' Â· '+p.noTransfer:'')+'</span></td>'
      +'<td style="font-size:.78rem;color:var(--text-muted);">'+p.tglBayar+'</td>'
      +'<td><span style="display:inline-flex;align-items:center;gap:.25rem;font-size:.72rem;background:'+konfBg+';color:'+konfColor+';padding:.15rem .5rem;border-radius:8px;font-weight:600;white-space:nowrap;">'+konfIcon+' '+(p.dikonfirmasiOleh||'â€”')+'</span></td>'
      +'<td style="font-size:.75rem;color:var(--text-muted);white-space:nowrap;">'+(p.tglKonfirmasi||p.tglBayar||'â€”')+'</td></tr>';
  }).join('');
}

// ============ TOKEN ADD MEMBER ============
function tokAddMember(){
  const nama=document.getElementById('tok-new-name').value.trim();
  if(!nama){toast('Masukkan nama!');return;}
  if(getMember(nama)){toast('Nama sudah terdaftar!');return;}
  const sek=S.currentToken.sektor;
  S.members.push({id:uid(),nama,sektor:sek});
  save();renderTokenDashboard();renderPubStats();
  document.getElementById('tok-new-name').value='';
  toast('Anggota '+nama+' ditambahkan ke '+SEKTOR_NAMES[sek]+'!');
}

// ============ ADMIN ADD MEMBER ============
function addMember(){
  const nama=document.getElementById('new-name').value.trim();
  if(!nama){toast('Masukkan nama!');return;}
  if(getMember(nama)){toast('Nama sudah terdaftar!');return;}
  if(!selectedSector){toast('Pilih sektor untuk anggota!');return;}
  S.members.push({id:uid(),nama,sektor:selectedSector});
  save();renderAdmin();
  document.getElementById('new-name').value='';
  toast('Anggota '+nama+' ditambahkan ke '+SEKTOR_NAMES[selectedSector]+'!');
}
function deleteMember(id){
  const m=S.members.find(x=>x.id===id);
  if(!m||!confirm('Hapus '+m.nama+'? Semua datanya juga terhapus.'))return;
  S.members=S.members.filter(x=>x.id!==id);
  S.payments=S.payments.filter(p=>p.nama.toLowerCase()!==m.nama.toLowerCase());
  S.pending=S.pending.filter(p=>p.nama.toLowerCase()!==m.nama.toLowerCase());
  save();renderAdmin();toast('Anggota dihapus!');
}

// ============ KONFIRMASI PENDING ============
function confirmPending(id,fromToken){
  const p=S.pending.find(x=>x.id===id);if(!p)return;
  if(isLunas(p.nama)){toast(p.nama+' sudah LUNAS. Pengajuan dihapus.');S.pending=S.pending.filter(x=>x.id!==id);save();if(fromToken)renderTokenDashboard();else renderAdmin();return;}
  const sek=p.sektor||getMember(p.nama)?.sektor||0;
  const now=wkt();
  let dikonfirmasiOleh,tipeKonfirmasi;
  if(fromToken&&S.currentToken){
    dikonfirmasiOleh=S.currentToken.nama+' ('+SEKTOR_NAMES[S.currentToken.sektor]+')';
    tipeKonfirmasi='token';
  }else{
    dikonfirmasiOleh='Admin Utama';
    tipeKonfirmasi='admin';
  }
  S.payments.push({id:uid(),nama:p.nama,sektor:sek,bulan:p.bulan,nominal:p.nominal,
    metode:'Transfer',tglBayar:tgl(),
    tglKonfirmasi:now,dikonfirmasiOleh,tipeKonfirmasi,
    noTransfer:p.noTransfer,catatan:p.catatan||''});
  S.pending=S.pending.filter(x=>x.id!==id);
  save();if(fromToken)renderTokenDashboard();else renderAdmin();autoSync();
  toast(getSisa(p.nama)===0?p.nama+' LUNAS!':'Dikonfirmasi. Sisa: '+rp(getSisa(p.nama)));
}
function rejectPending(id){
  const p=S.pending.find(x=>x.id===id);
  if(!p||!confirm('Tolak pengajuan dari '+p.nama+'?'))return;
  S.pending=S.pending.filter(x=>x.id!==id);
  save();
  if(S.tokenLoggedIn)renderTokenDashboard();else renderAdmin();
  toast('Pengajuan '+p.nama+' ditolak.');
}

// ============ SETTINGS ============
function loadSettings(){
  document.getElementById('set-org').value=S.settings.org||'';
  document.getElementById('set-tahun').value=S.settings.tahun||2025;
  document.getElementById('set-nominal').value=S.settings.nominal||90000;
  const gsEl=document.getElementById('gs-url'); if(gsEl) gsEl.value=S.settings.gsUrl||'';
  renderAdminTokenList();
  // Populate Firebase config fields
  if(fbConfig&&fbConfig.apiKey){
    const fields={
      's-fb-apiKey':fbConfig.apiKey,
      's-fb-authDomain':fbConfig.authDomain||'',
      's-fb-projectId':fbConfig.projectId||'',
      's-fb-storageBucket':fbConfig.storageBucket||'',
      's-fb-appId':fbConfig.appId||''
    };
    Object.entries(fields).forEach(([id,val])=>{
      const el=document.getElementById(id); if(el) el.value=val;
    });
    const infoEl=document.getElementById('fb-current-info');
    if(infoEl) infoEl.innerHTML='<div class="fb-status '+(fbConnected?'fb-online':'fb-offline')+'" style="margin-bottom:.5rem;">'+(fbConnected?'ğŸŸ¢ Terhubung ke Firebase':'ğŸ”´ Tidak terhubung')+' &mdash; Project: <strong>'+fbConfig.projectId+'</strong></div>';
  }
}
function saveSetting(){
  S.settings.org=document.getElementById('set-org').value||'Seksi Bapa';
  S.settings.tahun=parseInt(document.getElementById('set-tahun').value)||2025;
  S.settings.nominal=parseInt(document.getElementById('set-nominal').value)||90000;
  const np=document.getElementById('set-pass').value;
  if(np)S.settings.password=np;
  save();updateBadge();renderAdmin();toast('Pengaturan disimpan!');
}
function saveGsUrl(){S.settings.gsUrl=document.getElementById('gs-url').value.trim();save();toast('URL disimpan!');}

function renderAdminTokenList(){
  const el=document.getElementById('admin-token-list');
  if(!el)return;
  const sColors=[null,'#1B4F8A','#2D5A3D','#6B2D8B','#8B3A0F'];
  const sBg=[null,'#dbeafe','#d1fae5','#ede9fe','#ffedd5'];
  el.innerHTML=S.settings.tokens.map(t=>'<div class="tok-card">'
    +'<div style="width:32px;height:32px;border-radius:8px;background:'+sBg[t.sektor]+';display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0;">ğŸ”‘</div>'
    +'<div class="tok-info">'
    +'<div class="tok-name" style="color:'+sColors[t.sektor]+';">'+SEKTOR_NAMES[t.sektor]+'</div>'
    +'<div class="tok-sector">Pengurus: <input type="text" id="tname-'+t.sektor+'" value="'+t.nama+'" style="display:inline;width:auto;padding:.1rem .4rem;font-size:.8rem;height:auto;background:var(--cream);border-radius:5px;border:1px solid var(--border);min-width:150px;"></div>'
    +'<div style="margin-top:.25rem;display:flex;align-items:center;gap:.4rem;">'
    +'<span style="font-size:.75rem;color:var(--text-muted);">Token:</span>'
    +'<input type="text" id="tval-'+t.sektor+'" value="'+t.token+'" style="display:inline;width:auto;padding:.1rem .4rem;font-size:.8rem;font-family:monospace;height:auto;background:#d1fae5;border-radius:5px;border:1px solid #6ee7b7;min-width:120px;color:var(--green);">'
    +'</div></div>'
    +'<button class="btn btn-gold btn-sm" onclick="saveTokenSektor('+t.sektor+')">Simpan</button>'
    +'</div>').join('');
}
function saveTokenSektor(sektor){
  const tok=S.settings.tokens.find(t=>t.sektor===sektor);
  if(!tok)return;
  const namaEl=document.getElementById('tname-'+sektor);
  const valEl=document.getElementById('tval-'+sektor);
  if(!namaEl||!valEl)return;
  const newNama=namaEl.value.trim(),newVal=valEl.value.trim();
  if(!newNama){toast('Masukkan nama pengurus!');return;}
  if(newVal.length<4){toast('Token minimal 4 karakter!');return;}
  // Cek duplikat token di sektor lain
  const dup=S.settings.tokens.find(t=>t.token===newVal&&t.sektor!==sektor);
  if(dup){toast('Token sudah digunakan sektor lain!');return;}
  tok.nama=newNama;tok.token=newVal;
  save();toast('Token '+SEKTOR_NAMES[sektor]+' disimpan!');
}

function confirmReset(){
  if(confirm('Hapus SEMUA data pembayaran dan pengajuan? Daftar anggota tetap. Yakin?')){
    S.payments=[];S.pending=[];save();renderAdmin();toast('Semua data pembayaran dihapus!');
  }
}

// ============ EXPORT CSV ============
function exportCSV(){
  let csv='No,Nama,Sektor,Total Dibayar,Sisa,Status\n';
  S.members.forEach((m,i)=>{
    csv+=''+(i+1)+',"'+m.nama+'","'+SEKTOR_NAMES[m.sektor]+'",'+getPaid(m.nama)+','+getSisa(m.nama)+','+(isLunas(m.nama)?'Lunas':'Belum Lunas')+'\n';
  });
  dlCSV(csv,'rekap-iuran-'+S.settings.tahun+'.csv');
  toast('CSV diunduh!');
}
function exportSektorCSV(){
  if(!S.currentToken)return;
  const sek=S.currentToken.sektor;
  let csv='No,Nama,Total Dibayar,Sisa,Status\n';
  getMemberSektor(sek).forEach((m,i)=>{
    csv+=''+(i+1)+',"'+m.nama+'",'+getPaid(m.nama)+','+getSisa(m.nama)+','+(isLunas(m.nama)?'Lunas':'Belum Lunas')+'\n';
  });
  dlCSV(csv,'rekap-'+SEKTOR_NAMES[sek].replace(' ','-')+'-'+S.settings.tahun+'.csv');
  toast('CSV diunduh!');
}
function dlCSV(csv,fname){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=fname;a.click();
}

// ============ GOOGLE SHEETS ============
function buildPayload(){
  return{
    rows:S.members.map(m=>({nama:m.nama,sektor:SEKTOR_NAMES[m.sektor],total:getPaid(m.nama),sisa:getSisa(m.nama),status:isLunas(m.nama)?'Lunas':'Belum Lunas',updateAt:wkt()})),
    riwayat:S.payments.map(p=>({nama:p.nama,sektor:SEKTOR_NAMES[p.sektor||0]||'-',bulan:BULAN[p.bulan],nominal:p.nominal,metode:p.metode,tglBayar:p.tglBayar,dikonfirmasiOleh:p.dikonfirmasiOleh||'-',tglKonfirmasi:p.tglKonfirmasi||p.tglBayar})),
    pending:S.pending.map(p=>({nama:p.nama,sektor:SEKTOR_NAMES[p.sektor||0]||'-',bulan:BULAN[p.bulan],nominal:p.nominal,noTransfer:p.noTransfer,catatan:p.catatan||'-',tglSubmit:p.tglSubmit}))
  };
}
async function syncToSheets(){
  const url=document.getElementById('gs-url').value.trim();
  if(!url){toast('Masukkan URL Apps Script!');return;}
  const st=document.getElementById('sync-status');
  st.style.display='block';st.style.background='#fef3c7';st.style.color='var(--orange)';st.textContent='Mengirim data...';
  try{
    await fetch(url,{method:'POST',body:JSON.stringify(buildPayload()),headers:{'Content-Type':'application/json'}});
    st.style.background='#d1fae5';st.style.color='var(--green)';st.textContent='Berhasil! Update: '+wkt();toast('Google Sheets diperbarui!');
  }catch(e){st.style.background='#fee2e2';st.style.color='var(--red-light)';st.textContent='Gagal. Periksa URL Apps Script.';toast('Sinkronisasi gagal!');}
}
async function tokSyncToSheets(){
  const url=document.getElementById('tok-gs-url').value.trim();
  if(!url){toast('Masukkan URL Apps Script!');return;}
  const st=document.getElementById('tok-sync-status');
  st.style.display='block';st.style.background='#fef3c7';st.style.color='var(--orange)';st.textContent='Mengirim data sektor...';
  // Build sektor-specific payload
  const sek=S.currentToken.sektor;
  const ms=getMemberSektor(sek);
  const payload={
    rows:ms.map(m=>({nama:m.nama,sektor:SEKTOR_NAMES[sek],total:getPaid(m.nama),sisa:getSisa(m.nama),status:isLunas(m.nama)?'Lunas':'Belum Lunas',updateAt:wkt()})),
    riwayat:S.payments.filter(p=>p.sektor===sek).map(p=>({nama:p.nama,sektor:SEKTOR_NAMES[sek],bulan:BULAN[p.bulan],nominal:p.nominal,metode:p.metode,tglBayar:p.tglBayar})),
    pending:S.pending.filter(p=>p.sektor===sek).map(p=>({nama:p.nama,sektor:SEKTOR_NAMES[sek],bulan:BULAN[p.bulan],nominal:p.nominal,noTransfer:p.noTransfer,catatan:p.catatan||'-',tglSubmit:p.tglSubmit}))
  };
  try{
    await fetch(url,{method:'POST',body:JSON.stringify(payload),headers:{'Content-Type':'application/json'}});
    st.style.background='#d1fae5';st.style.color='var(--green)';st.textContent='Berhasil! Update: '+wkt();toast('Google Sheets diperbarui!');
    S.settings.gsUrl=url;save();
  }catch(e){st.style.background='#fee2e2';st.style.color='var(--red-light)';st.textContent='Gagal. Periksa URL Apps Script.';toast('Sinkronisasi gagal!');}
}
function tokSaveGsUrl(){S.settings.gsUrl=document.getElementById('tok-gs-url').value.trim();save();toast('URL disimpan!');}
async function autoSync(){
  if(!S.settings.gsUrl)return;
  try{await fetch(S.settings.gsUrl,{method:'POST',body:JSON.stringify(buildPayload()),headers:{'Content-Type':'application/json'}});}catch(e){}
}
function copyScript(){
  navigator.clipboard.writeText(document.getElementById('gs-script').textContent)
    .then(()=>toast('Script berhasil dicopy!')).catch(()=>toast('Gagal copy'));
}

(async function startApp(){
  // Config langsung dari config.js â€” tidak perlu setup page
  const savedConfig = await loadFbConfig();

  if (savedConfig && savedConfig.apiKey && savedConfig.projectId) {
    updateFbIndicators('connecting');
    const fbOk = await initFirebase(savedConfig);
    if (fbOk) {
      updateFbIndicators('online');
    } else {
      updateFbIndicators('offline');
    }
  } else {
    // config.js belum diisi â€” tetap jalankan app dengan local fallback
    updateFbIndicators('offline');
    console.warn('FIREBASE_CONFIG tidak ditemukan. Edit file config.js.');
  }

  // Load data & init app
  await loadState();
  init();
})();
</script>
</body>
</html>
